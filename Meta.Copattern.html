<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Meta.Copattern</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Comment">-- Reed Mullanix 2024</a>
<a id="23" class="Symbol">{-#</a> <a id="27" class="Keyword">OPTIONS</a> <a id="35" class="Pragma">--safe</a> <a id="42" class="Pragma">--no-exact-split</a> <a id="59" class="Symbol">#-}</a>
<a id="63" class="Keyword">module</a> <a id="70" href="Meta.Copattern.html" class="Module">Meta.Copattern</a> <a id="85" class="Keyword">where</a>

<a id="92" class="Keyword">open</a> <a id="97" class="Keyword">import</a> <a id="104" href="Foundations.Prelude.html" class="Module">Foundations.Prelude</a>

<a id="125" class="Keyword">open</a> <a id="130" class="Keyword">import</a> <a id="137" href="Meta.Effect.Alt.html" class="Module">Meta.Effect.Alt</a>
<a id="153" class="Keyword">open</a> <a id="158" class="Keyword">import</a> <a id="165" href="Meta.Effect.Traversable.html" class="Module">Meta.Effect.Traversable</a>
<a id="189" class="Keyword">open</a> <a id="194" class="Keyword">import</a> <a id="201" href="Meta.Reflection.Argument.html" class="Module">Meta.Reflection.Argument</a>
<a id="226" class="Keyword">open</a> <a id="231" class="Keyword">import</a> <a id="238" href="Meta.Reflection.Base.html" class="Module">Meta.Reflection.Base</a>
<a id="259" class="Keyword">open</a> <a id="264" class="Keyword">import</a> <a id="271" href="Meta.Reflection.Signature.html" class="Module">Meta.Reflection.Signature</a>
<a id="297" class="Keyword">open</a> <a id="302" class="Keyword">import</a> <a id="309" href="Meta.Reflection.Subst.html" class="Module">Meta.Reflection.Subst</a>

<a id="332" class="Keyword">open</a> <a id="337" class="Keyword">import</a> <a id="344" href="Data.Bool.Base.html" class="Module">Data.Bool.Base</a>
<a id="359" class="Keyword">open</a> <a id="364" class="Keyword">import</a> <a id="371" href="Data.List.Base.html" class="Module">Data.List.Base</a>
<a id="386" class="Keyword">open</a> <a id="391" class="Keyword">import</a> <a id="398" href="Data.List.Operations.html" class="Module">Data.List.Operations</a>
<a id="419" class="Keyword">open</a> <a id="424" class="Keyword">import</a> <a id="431" href="Data.List.Instances.FromProduct.html" class="Module">Data.List.Instances.FromProduct</a>
<a id="463" class="Keyword">open</a> <a id="468" class="Keyword">import</a> <a id="475" href="Data.List.Instances.Traversable.html" class="Module">Data.List.Instances.Traversable</a>
<a id="507" class="Keyword">open</a> <a id="512" class="Keyword">import</a> <a id="519" href="Data.Reflection.Argument.html" class="Module">Data.Reflection.Argument</a>
<a id="544" class="Keyword">open</a> <a id="549" class="Keyword">import</a> <a id="556" href="Data.Reflection.Error.html" class="Module">Data.Reflection.Error</a>
<a id="578" class="Keyword">open</a> <a id="583" class="Keyword">import</a> <a id="590" href="Data.Reflection.Instances.FromString.html" class="Module">Data.Reflection.Instances.FromString</a>
<a id="627" class="Keyword">open</a> <a id="632" class="Keyword">import</a> <a id="639" href="Data.Reflection.Name.html" class="Module">Data.Reflection.Name</a>
<a id="660" class="Keyword">open</a> <a id="665" class="Keyword">import</a> <a id="672" href="Data.Reflection.Term.html" class="Module">Data.Reflection.Term</a>
<a id="693" class="Keyword">open</a> <a id="698" class="Keyword">import</a> <a id="705" href="Data.String.Base.html" class="Module">Data.String.Base</a>

<a id="723" class="Comment">--------------------------------------------------------------------------------</a>
<a id="804" class="Comment">-- Macros for manipulating copattern definitions.</a>

<a id="855" class="Comment">-- Make a top-level copattern binding for an existing record.</a>
<a id="make-copattern"></a><a id="917" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="932" class="Symbol">:</a> <a id="934" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="939" class="Symbol">→</a> <a id="941" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="946" class="Symbol">→</a> <a id="948" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="953" class="Symbol">→</a> <a id="955" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="960" class="Symbol">→</a> <a id="962" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="965" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="967" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="982" href="Meta.Copattern.html#982" class="Bound">declare?</a> <a id="991" href="Meta.Copattern.html#991" class="Bound">def-name</a> <a id="1000" href="Meta.Copattern.html#1000" class="Bound">tm</a> <a id="1003" href="Meta.Copattern.html#1003" class="Bound">tp</a> <a id="1006" class="Symbol">=</a> <a id="1008" class="Keyword">do</a>
  <a id="1013" class="Comment">-- Ensure that codomain is a record type.</a>
  <a id="1057" class="Keyword">let</a> <a id="1061" href="Meta.Copattern.html#1061" class="Bound">tele</a> <a id="1066" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1068" href="Meta.Copattern.html#1068" class="Bound">cod-tp</a> <a id="1075" class="Symbol">=</a> <a id="1077" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="1085" href="Meta.Copattern.html#1003" class="Bound">tp</a>
  <a id="1090" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="1094" href="Meta.Copattern.html#1094" class="Bound">rec-name</a> <a id="1103" href="Meta.Copattern.html#1103" class="Bound">params</a> <a id="1110" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="1112" href="Meta.Effect.Idiom.html#354" class="Field">pure</a> <a id="1117" href="Meta.Copattern.html#1068" class="Bound">cod-tp</a>
    <a id="1128" class="Keyword">where</a> <a id="1134" class="CatchallClause Symbol">_</a> <a id="1136" class="Symbol">→</a> <a id="1138" href="Agda.Builtin.Reflection.html#8830" class="Postulate">type-error</a> <a id="1149" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="1151" class="String">&quot;make-copattern: codomain of &quot;</a> <a id="1182" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1184" href="Data.Reflection.Error.html#191" class="InductiveConstructor">term-err</a> <a id="1193" href="Meta.Copattern.html#1003" class="Bound">tp</a> <a id="1196" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1198" class="String">&quot; is not a record type.&quot;</a> <a id="1223" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a>

  <a id="1228" href="Meta.Copattern.html#1228" class="Bound">inst-tm</a> <a id="1236" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="1238" href="Meta.Reflection.Subst.html#8006" class="Function">apply*TC</a> <a id="1247" href="Meta.Copattern.html#1000" class="Bound">tm</a> <a id="1250" class="Symbol">(</a><a id="1251" href="Meta.Reflection.Base.html#5140" class="Function">tel→args</a> <a id="1260" class="Number">0</a> <a id="1262" href="Meta.Copattern.html#1061" class="Bound">tele</a><a id="1266" class="Symbol">)</a>

  <a id="1271" class="Comment">-- Construct copattern clauses for each field.</a>
  <a id="1320" href="Meta.Copattern.html#1320" class="Bound">ctor</a> <a id="1325" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1327" href="Meta.Copattern.html#1327" class="Bound">fields</a> <a id="1334" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="1336" href="Meta.Reflection.Signature.html#1415" class="Function">get-record-type</a> <a id="1352" href="Meta.Copattern.html#1094" class="Bound">rec-name</a>
  <a id="1363" href="Meta.Copattern.html#1363" class="Bound">clauses</a> <a id="1371" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a>
    <a id="1377" href="Agda.Builtin.Reflection.html#9365" class="Postulate">in-context</a> <a id="1388" class="Symbol">(</a><a id="1389" href="Data.List.Base.html#955" class="Function">reverse-fast</a> <a id="1402" href="Meta.Copattern.html#1061" class="Bound">tele</a><a id="1406" class="Symbol">)</a> <a id="1408" href="Foundations.Pi.Base.html#1914" class="Function Operator">$</a>
      <a id="1416" href="Meta.Effect.Traversable.html#396" class="Function">for</a> <a id="1420" href="Meta.Copattern.html#1327" class="Bound">fields</a> <a id="1427" class="Symbol">λ</a> <a id="1429" class="Keyword">where</a> <a id="1435" class="Symbol">(</a><a id="1436" href="Agda.Builtin.Reflection.html#3732" class="InductiveConstructor">arg</a> <a id="1440" href="Meta.Copattern.html#1440" class="Bound">field-info</a> <a id="1451" href="Meta.Copattern.html#1451" class="Bound">field-name</a><a id="1461" class="Symbol">)</a> <a id="1463" class="Symbol">→</a> <a id="1465" class="Keyword">do</a>
      <a id="1474" class="Comment">-- Infer the type of the field with all known arguments instantiated.</a>
      <a id="1550" href="Meta.Copattern.html#1550" class="Bound">field-tp</a> <a id="1559" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="1561" href="Agda.Builtin.Reflection.html#8893" class="Postulate">infer-type</a> <a id="1572" class="Symbol">(</a><a id="1573" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="1577" href="Meta.Copattern.html#1451" class="Bound">field-name</a> <a id="1588" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="1590" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="1595" href="Meta.Copattern.html#1228" class="Bound">inst-tm</a> <a id="1603" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a><a id="1604" class="Symbol">)</a>

      <a id="1613" class="Comment">-- Agda will insert implicits when defining copatterns even</a>
      <a id="1679" class="Comment">-- with &#39;withExpandLast true&#39;, so we need to do implicit instantiation</a>
      <a id="1756" class="Comment">-- by hand. There are also cases where it&#39;s better to fully</a>
      <a id="1822" class="Comment">-- eta-expand than not (e.g. the &#39;helper&#39; we&#39;re expanding has a</a>
      <a id="1892" class="Comment">-- field defined by lazy matching, which does not reduce unless</a>
      <a id="1962" class="Comment">-- applied, and would cause duplication of the big input term). So</a>
      <a id="2035" class="Comment">-- we fully eta-expand clauses here.</a>
      <a id="2078" class="Comment">-- First, we strip off all leading quantifiers from the field</a>
      <a id="2146" class="Comment">-- type.</a>
      <a id="2161" class="Keyword">let</a> <a id="2165" href="Meta.Copattern.html#2165" class="Bound">field-tele</a> <a id="2176" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2178" href="Meta.Copattern.html#2178" class="Bound">tp</a> <a id="2181" class="Symbol">=</a> <a id="2183" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="2191" href="Meta.Copattern.html#1550" class="Bound">field-tp</a>
          <a id="2210" href="Meta.Copattern.html#2210" class="Bound">nargs</a> <a id="2216" class="Symbol">=</a> <a id="2218" href="Data.List.Operations.html#829" class="Function">length</a> <a id="2225" href="Meta.Copattern.html#2165" class="Bound">field-tele</a>
          <a id="2246" href="Meta.Copattern.html#2246" class="Bound">clause-tele</a> <a id="2258" class="Symbol">=</a> <a id="2260" href="Meta.Copattern.html#1061" class="Bound">tele</a> <a id="2265" href="Data.List.Base.html#725" class="Function Operator">++</a> <a id="2268" href="Meta.Copattern.html#2165" class="Bound">field-tele</a>

      <a id="2286" class="Comment">-- Construct the pattern portion of the clause, making sure to bind</a>
      <a id="2360" class="Comment">-- all implicit variables. Note that copattern projections are always visible.</a>
      <a id="2445" class="Keyword">let</a> <a id="2449" href="Meta.Copattern.html#2449" class="Bound">pat</a> <a id="2453" class="Symbol">=</a>
            <a id="2467" href="Meta.Reflection.Base.html#4989" class="Function">tel→pats</a> <a id="2476" href="Meta.Copattern.html#2210" class="Bound">nargs</a> <a id="2482" href="Meta.Copattern.html#1061" class="Bound">tele</a> <a id="2487" href="Data.List.Base.html#725" class="Function Operator">++</a>
            <a id="2502" href="Agda.Builtin.Reflection.html#3732" class="InductiveConstructor">arg</a> <a id="2506" class="Symbol">(</a><a id="2507" href="Meta.Reflection.Argument.html#345" class="Field">set-visibility</a> <a id="2522" href="Agda.Builtin.Reflection.html#2762" class="InductiveConstructor">visible</a> <a id="2530" href="Meta.Copattern.html#1440" class="Bound">field-info</a><a id="2540" class="Symbol">)</a> <a id="2542" class="Symbol">(</a><a id="2543" href="Agda.Builtin.Reflection.html#5977" class="InductiveConstructor">proj</a> <a id="2548" href="Meta.Copattern.html#1451" class="Bound">field-name</a><a id="2558" class="Symbol">)</a> <a id="2560" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a>
            <a id="2574" href="Meta.Reflection.Base.html#4989" class="Function">tel→pats</a> <a id="2583" class="Number">0</a> <a id="2585" href="Meta.Copattern.html#2165" class="Bound">field-tele</a>

      <a id="2603" class="Comment">-- Construct the body of the clause, making sure to apply all</a>
      <a id="2671" class="Comment">-- arguments bound outside the copattern match, and apply the</a>
      <a id="2739" class="Comment">-- eta-expanded arguments. We also need to apply all of the</a>
      <a id="2805" class="Comment">-- implicit arguments to &#39;tm&#39;.</a>
      <a id="2842" href="Meta.Copattern.html#2842" class="Bound">zz</a> <a id="2845" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="2847" href="Meta.Reflection.Subst.html#7503" class="Function">raiseTC</a> <a id="2855" href="Meta.Copattern.html#2210" class="Bound">nargs</a> <a id="2861" href="Meta.Copattern.html#1228" class="Bound">inst-tm</a>
      <a id="2875" href="Meta.Copattern.html#2875" class="Bound">body</a> <a id="2880" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a>
        <a id="2890" href="Agda.Builtin.Reflection.html#9365" class="Postulate">in-context</a> <a id="2901" class="Symbol">(</a><a id="2902" href="Data.List.Base.html#866" class="Function">reverse</a> <a id="2910" href="Meta.Copattern.html#2246" class="Bound">clause-tele</a><a id="2921" class="Symbol">)</a> <a id="2923" href="Foundations.Pi.Base.html#1914" class="Function Operator">$</a>
        <a id="2933" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="2940" class="Symbol">(</a><a id="2941" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="2945" href="Meta.Copattern.html#1451" class="Bound">field-name</a> <a id="2956" class="Symbol">(</a><a id="2957" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="2962" href="Meta.Copattern.html#2842" class="Bound">zz</a> <a id="2965" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="2967" href="Meta.Reflection.Base.html#5140" class="Function">tel→args</a> <a id="2976" class="Number">0</a> <a id="2978" href="Meta.Copattern.html#2165" class="Bound">field-tele</a><a id="2988" class="Symbol">))</a>

      <a id="2998" class="Comment">-- Construct the final clause.</a>
      <a id="3035" href="Meta.Effect.Idiom.html#354" class="Field">pure</a> <a id="3040" href="Foundations.Pi.Base.html#1914" class="Function Operator">$</a> <a id="3042" href="Agda.Builtin.Reflection.html#6106" class="InductiveConstructor">clause</a> <a id="3049" href="Meta.Copattern.html#2246" class="Bound">clause-tele</a> <a id="3061" href="Meta.Copattern.html#2449" class="Bound">pat</a> <a id="3065" href="Meta.Copattern.html#2875" class="Bound">body</a>

  <a id="3073" class="Comment">-- Define a copattern binding, and predeclare its type if required.</a>
  <a id="3143" href="Meta.Effect.Idiom.html#533" class="Function">when</a> <a id="3148" href="Meta.Copattern.html#982" class="Bound">declare?</a> <a id="3157" class="Keyword">do</a>
    <a id="3164" href="Agda.Builtin.Reflection.html#9468" class="Postulate">declare-def</a> <a id="3176" class="Symbol">(</a><a id="3177" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="3182" href="Meta.Copattern.html#991" class="Bound">def-name</a><a id="3190" class="Symbol">)</a> <a id="3192" href="Meta.Copattern.html#1003" class="Bound">tp</a> <a id="3195" href="Meta.Effect.Alt.html#320" class="Field Operator">&lt;|&gt;</a> <a id="3199" href="Meta.Effect.Idiom.html#354" class="Field">pure</a> <a id="3204" href="Agda.Builtin.Unit.html#212" class="InductiveConstructor">tt</a>

  <a id="3210" class="Comment">-- Construct the final copattern.</a>
  <a id="3246" href="Agda.Builtin.Reflection.html#9683" class="Postulate">define-function</a> <a id="3262" href="Meta.Copattern.html#991" class="Bound">def-name</a> <a id="3271" href="Meta.Copattern.html#1363" class="Bound">clauses</a>

<a id="3280" class="Comment">-- Repack a record type.</a>
<a id="3305" class="Comment">-- Will also accept functions into record types like `A → Record`,</a>
<a id="3372" class="Comment">-- and will perform a pointwise repacking.</a>
<a id="repack-record"></a><a id="3415" href="Meta.Copattern.html#3415" class="Function">repack-record</a> <a id="3429" class="Symbol">:</a> <a id="3431" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="3436" class="Symbol">→</a> <a id="3438" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="3443" class="Symbol">→</a> <a id="3445" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="3448" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a>
<a id="3453" href="Meta.Copattern.html#3415" class="Function">repack-record</a> <a id="3467" href="Meta.Copattern.html#3467" class="Bound">tm</a> <a id="3470" href="Meta.Copattern.html#3470" class="Bound">tp</a> <a id="3473" class="Symbol">=</a> <a id="3475" class="Keyword">do</a>
  <a id="3480" class="Comment">-- Ensure that codomain is a record type.</a>
  <a id="3524" href="Meta.Copattern.html#3524" class="Bound">tele</a> <a id="3529" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3531" href="Meta.Copattern.html#3531" class="Bound">cod-tp</a> <a id="3538" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="3540" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="3548" href="Meta.Effect.Map.html#494" class="Function Operator">&lt;$&gt;</a> <a id="3552" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="3559" href="Meta.Copattern.html#3470" class="Bound">tp</a>
  <a id="3564" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="3568" href="Meta.Copattern.html#3568" class="Bound">rec-name</a> <a id="3577" href="Meta.Copattern.html#3577" class="Bound">params</a> <a id="3584" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="3586" href="Meta.Effect.Idiom.html#354" class="Field">pure</a> <a id="3591" href="Meta.Copattern.html#3531" class="Bound">cod-tp</a>
    <a id="3602" class="Keyword">where</a> <a id="3608" class="CatchallClause Symbol">_</a> <a id="3610" class="Symbol">→</a> <a id="3612" href="Agda.Builtin.Reflection.html#8830" class="Postulate">type-error</a> <a id="3623" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="3625" class="String">&quot;repack-record: codomain of &quot;</a> <a id="3655" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3657" href="Data.Reflection.Error.html#191" class="InductiveConstructor">term-err</a> <a id="3666" href="Meta.Copattern.html#3470" class="Bound">tp</a> <a id="3669" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3671" class="String">&quot; is not a record type.&quot;</a> <a id="3696" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a>

  <a id="3701" class="Comment">-- Instantiate the term with all telescope arguments to saturate it.</a>
  <a id="3772" href="Meta.Copattern.html#3772" class="Bound">inst-tm</a> <a id="3780" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="3782" href="Meta.Reflection.Subst.html#8006" class="Function">apply*TC</a> <a id="3791" href="Meta.Copattern.html#3467" class="Bound">tm</a> <a id="3794" class="Symbol">(</a><a id="3795" href="Meta.Reflection.Base.html#5140" class="Function">tel→args</a> <a id="3804" class="Number">0</a> <a id="3806" href="Meta.Copattern.html#3524" class="Bound">tele</a><a id="3810" class="Symbol">)</a>

  <a id="3815" class="Comment">-- Construct fields for each projection.</a>
  <a id="3858" href="Meta.Copattern.html#3858" class="Bound">ctor</a> <a id="3863" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3865" href="Meta.Copattern.html#3865" class="Bound">fields</a> <a id="3872" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="3874" href="Meta.Reflection.Signature.html#1415" class="Function">get-record-type</a> <a id="3890" href="Meta.Copattern.html#3568" class="Bound">rec-name</a>
  <a id="3901" href="Meta.Copattern.html#3901" class="Bound">args</a> <a id="3906" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="3908" href="Agda.Builtin.Reflection.html#9365" class="Postulate">in-context</a> <a id="3919" class="Symbol">(</a><a id="3920" href="Data.List.Base.html#955" class="Function">reverse-fast</a> <a id="3933" href="Meta.Copattern.html#3524" class="Bound">tele</a><a id="3937" class="Symbol">)</a> <a id="3939" href="Foundations.Pi.Base.html#1914" class="Function Operator">$</a>
    <a id="3945" href="Meta.Effect.Traversable.html#396" class="Function">for</a> <a id="3949" href="Meta.Copattern.html#3865" class="Bound">fields</a> <a id="3956" class="Symbol">λ</a> <a id="3958" class="Keyword">where</a> <a id="3964" class="Symbol">(</a><a id="3965" href="Agda.Builtin.Reflection.html#3732" class="InductiveConstructor">arg</a> <a id="3969" href="Meta.Copattern.html#3969" class="Bound">field-info</a> <a id="3980" href="Meta.Copattern.html#3980" class="Bound">field-name</a><a id="3990" class="Symbol">)</a> <a id="3992" class="Symbol">→</a>
                         <a id="4019" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="4024" href="Meta.Effect.Map.html#494" class="Function Operator">&lt;$&gt;</a> <a id="4028" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="4035" class="Symbol">(</a><a id="4036" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="4040" href="Meta.Copattern.html#3980" class="Bound">field-name</a> <a id="4051" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="4053" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="4058" href="Meta.Copattern.html#3772" class="Bound">inst-tm</a> <a id="4066" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a><a id="4067" class="Symbol">)</a>

  <a id="4072" class="Comment">-- Builld a pointwise repacking.</a>
  <a id="4107" href="Meta.Effect.Idiom.html#354" class="Field">pure</a> <a id="4112" class="Symbol">(</a><a id="4113" href="Data.Reflection.Term.html#1917" class="Function">tel→lam</a> <a id="4121" href="Meta.Copattern.html#3524" class="Bound">tele</a> <a id="4126" class="Symbol">(</a><a id="4127" href="Agda.Builtin.Reflection.html#5194" class="InductiveConstructor">con</a> <a id="4131" href="Meta.Copattern.html#3858" class="Bound">ctor</a> <a id="4136" href="Meta.Copattern.html#3901" class="Bound">args</a><a id="4140" class="Symbol">))</a>

<a id="4144" class="Comment">-- Helper for the &#39;define&#39; macros; Unifies the given goal with the type</a>
<a id="4216" class="Comment">-- of the given function, if it has been defined. If the function has</a>
<a id="4286" class="Comment">-- not been defined, and the first argument is &#39;false&#39;, then an error is</a>
<a id="4359" class="Comment">-- raised.</a>
<a id="type-for"></a><a id="4370" href="Meta.Copattern.html#4370" class="Function">type-for</a> <a id="4379" class="Symbol">:</a> <a id="4381" href="Agda.Builtin.String.html#335" class="Postulate">String</a> <a id="4388" class="Symbol">→</a> <a id="4390" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="4395" class="Symbol">→</a> <a id="4397" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="4402" class="Symbol">→</a> <a id="4404" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="4409" class="Symbol">→</a> <a id="4411" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="4414" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="4416" href="Meta.Copattern.html#4370" class="Function">type-for</a> <a id="4425" href="Meta.Copattern.html#4425" class="Bound">tac</a> <a id="4429" href="Meta.Copattern.html#4429" class="Bound">decl?</a> <a id="4435" href="Meta.Copattern.html#4435" class="Bound">fun</a> <a id="4439" href="Meta.Copattern.html#4439" class="Bound">goal</a> <a id="4444" class="Symbol">=</a> <a id="4446" class="Symbol">(</a><a id="4447" href="Agda.Builtin.Reflection.html#9730" class="Postulate">get-type</a> <a id="4456" href="Meta.Copattern.html#4435" class="Bound">fun</a> <a id="4460" href="Meta.Effect.Bind.html#283" class="Field Operator">&gt;&gt;=</a> <a id="4464" href="Agda.Builtin.Reflection.html#8790" class="Postulate">unify</a> <a id="4470" href="Meta.Copattern.html#4439" class="Bound">goal</a><a id="4474" class="Symbol">)</a> <a id="4476" href="Meta.Effect.Alt.html#320" class="Field Operator">&lt;|&gt;</a> <a id="4480" class="Keyword">do</a>
  <a id="4485" href="Meta.Effect.Idiom.html#608" class="Function">unless</a> <a id="4492" href="Meta.Copattern.html#4429" class="Bound">decl?</a> <a id="4498" href="Foundations.Pi.Base.html#1914" class="Function Operator">$</a> <a id="4500" href="Agda.Builtin.Reflection.html#8830" class="Postulate">type-error</a>
    <a id="4515" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="4517" class="String">&quot;define-&quot;</a> <a id="4527" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4529" href="Data.Reflection.Error.html#159" class="InductiveConstructor">str-err</a> <a id="4537" href="Meta.Copattern.html#4425" class="Bound">tac</a> <a id="4541" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4543" class="String">&quot;: the function &quot;</a>
    <a id="4565" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4567" href="Data.Reflection.Error.html#256" class="InductiveConstructor">name-err</a> <a id="4576" href="Meta.Copattern.html#4435" class="Bound">fun</a> <a id="4580" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4582" class="String">&quot; should already have been declared.&quot;</a>
    <a id="4624" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a>


<a id="4628" class="Comment">--------------------------------------------------------------------------------</a>
<a id="4709" class="Comment">-- Usage</a>

<a id="4719" class="Comment">{-
Write the following in a module:
&gt;  unquoteDecl copat = declare-copattern copat thing-to-be-expanded
If you wish to give the binding a type annotation, you can also use
&gt;  copat : Your-type
&gt;  unquoteDecl copat = declare-copattern copat thing-to-be-expanded
All features of non-recursive records are supported, including instance
fields and fields with implicit arguments.
These macros also allow you to lift functions &#39;A → some-record-type&#39;
into copattern definitions. Note that Agda will generate meta for
implicits before performing quotation, so we need to explicitly
bind all implicits using a lambda before quotation!
-}</a>

<a id="declare-copattern"></a><a id="5350" href="Meta.Copattern.html#5350" class="Function">declare-copattern</a> <a id="5368" class="Symbol">:</a> <a id="5370" class="Symbol">∀</a> <a id="5372" class="Symbol">{</a><a id="5373" href="Meta.Copattern.html#5373" class="Bound">ℓ</a><a id="5374" class="Symbol">}</a> <a id="5376" class="Symbol">{</a><a id="5377" href="Meta.Copattern.html#5377" class="Bound">A</a> <a id="5379" class="Symbol">:</a> <a id="5381" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="5386" href="Meta.Copattern.html#5373" class="Bound">ℓ</a><a id="5387" class="Symbol">}</a> <a id="5389" class="Symbol">→</a> <a id="5391" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="5396" class="Symbol">→</a> <a id="5398" href="Meta.Copattern.html#5377" class="Bound">A</a> <a id="5400" class="Symbol">→</a> <a id="5402" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="5405" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5407" href="Meta.Copattern.html#5350" class="Function">declare-copattern</a> <a id="5425" class="Symbol">{</a><a id="5426" class="Argument">A</a> <a id="5428" class="Symbol">=</a> <a id="5430" href="Meta.Copattern.html#5430" class="Bound">A</a><a id="5431" class="Symbol">}</a> <a id="5433" href="Meta.Copattern.html#5433" class="Bound">nm</a> <a id="5436" href="Meta.Copattern.html#5436" class="Bound">x</a> <a id="5438" class="Symbol">=</a> <a id="5440" class="Keyword">do</a>
  <a id="5445" href="Meta.Copattern.html#5445" class="Bound">`x</a> <a id="5448" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="5450" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5458" href="Meta.Copattern.html#5436" class="Bound">x</a>
  <a id="5462" href="Meta.Copattern.html#5462" class="Bound">`A</a> <a id="5465" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="5467" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5475" href="Meta.Copattern.html#5430" class="Bound">A</a>
  <a id="5479" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="5494" href="Agda.Builtin.Bool.html#198" class="InductiveConstructor">true</a> <a id="5499" href="Meta.Copattern.html#5433" class="Bound">nm</a> <a id="5502" href="Meta.Copattern.html#5445" class="Bound">`x</a> <a id="5505" href="Meta.Copattern.html#5462" class="Bound">`A</a>

<a id="define-copattern"></a><a id="5509" href="Meta.Copattern.html#5509" class="Function">define-copattern</a>
  <a id="5528" class="Symbol">:</a> <a id="5530" class="Symbol">∀</a> <a id="5532" class="Symbol">{</a><a id="5533" href="Meta.Copattern.html#5533" class="Bound">ℓ</a><a id="5534" class="Symbol">}</a> <a id="5536" class="Symbol">(</a><a id="5537" href="Meta.Copattern.html#5537" class="Bound">nm</a> <a id="5540" class="Symbol">:</a> <a id="5542" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a><a id="5546" class="Symbol">)</a>
  <a id="5550" class="Symbol">→</a> <a id="5552" class="Symbol">{@(</a><a id="5555" class="Keyword">tactic</a> <a id="5562" class="Symbol">(</a><a id="5563" href="Meta.Copattern.html#4370" class="Function">type-for</a> <a id="5572" class="String">&quot;copattern&quot;</a> <a id="5584" href="Agda.Builtin.Bool.html#198" class="InductiveConstructor">true</a> <a id="5589" href="Meta.Copattern.html#5537" class="Bound">nm</a><a id="5591" class="Symbol">))</a> <a id="5594" href="Meta.Copattern.html#5594" class="Bound">A</a> <a id="5596" class="Symbol">:</a> <a id="5598" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="5603" href="Meta.Copattern.html#5533" class="Bound">ℓ</a><a id="5604" class="Symbol">}</a>
  <a id="5608" class="Symbol">→</a> <a id="5610" href="Meta.Copattern.html#5594" class="Bound">A</a> <a id="5612" class="Symbol">→</a> <a id="5614" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="5617" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5619" href="Meta.Copattern.html#5509" class="Function">define-copattern</a> <a id="5636" href="Meta.Copattern.html#5636" class="Bound">nm</a> <a id="5639" class="Symbol">{</a><a id="5640" href="Meta.Copattern.html#5640" class="Bound">A</a><a id="5641" class="Symbol">}</a> <a id="5643" href="Meta.Copattern.html#5643" class="Bound">x</a> <a id="5645" class="Symbol">=</a> <a id="5647" class="Keyword">do</a>
  <a id="5652" href="Meta.Copattern.html#5652" class="Bound">`A</a> <a id="5655" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="5657" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5665" href="Meta.Copattern.html#5640" class="Bound">A</a>
  <a id="5669" href="Meta.Copattern.html#5669" class="Bound">`x</a> <a id="5672" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="5674" href="Meta.Reflection.Signature.html#8336" class="Function">define-abbrev</a> <a id="5688" href="Meta.Copattern.html#5636" class="Bound">nm</a> <a id="5691" class="String">&quot;value&quot;</a> <a id="5699" href="Meta.Copattern.html#5652" class="Bound">`A</a> <a id="5702" href="Meta.Effect.Bind.html#427" class="Function Operator">=&lt;&lt;</a> <a id="5706" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5714" href="Meta.Copattern.html#5643" class="Bound">x</a>
  <a id="5718" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="5733" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="5739" href="Meta.Copattern.html#5636" class="Bound">nm</a> <a id="5742" href="Meta.Copattern.html#5669" class="Bound">`x</a> <a id="5745" href="Meta.Copattern.html#5652" class="Bound">`A</a>

<a id="5749" class="Comment">{-
There is a slight caveat with level-polymorphic defintions, as
they cannot be quoted into any `Type ℓ`. With this in mind,
we also provide a pair of macros that work over `Typeω` instead.
-}</a>

<a id="declare-copatternω"></a><a id="5944" href="Meta.Copattern.html#5944" class="Function">declare-copatternω</a> <a id="5963" class="Symbol">:</a> <a id="5965" class="Symbol">∀</a> <a id="5967" class="Symbol">{</a><a id="5968" href="Meta.Copattern.html#5968" class="Bound">U</a> <a id="5970" class="Symbol">:</a> <a id="5972" href="Foundations.Prim.Type.html#349" class="Primitive">Typeω</a><a id="5977" class="Symbol">}</a> <a id="5979" class="Symbol">→</a> <a id="5981" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="5986" class="Symbol">→</a> <a id="5988" href="Meta.Copattern.html#5968" class="Bound">U</a> <a id="5990" class="Symbol">→</a> <a id="5992" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="5995" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5997" href="Meta.Copattern.html#5944" class="Function">declare-copatternω</a> <a id="6016" href="Meta.Copattern.html#6016" class="Bound">nm</a> <a id="6019" href="Meta.Copattern.html#6019" class="Bound">A</a> <a id="6021" class="Symbol">=</a> <a id="6023" class="Keyword">do</a>
  <a id="6028" href="Meta.Copattern.html#6028" class="Bound">`A</a> <a id="6031" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="6033" href="Agda.Builtin.Reflection.html#9210" class="Postulate">quoteωTC</a> <a id="6042" href="Meta.Copattern.html#6019" class="Bound">A</a>
  <a id="6046" class="Comment">-- Cannot quote things in type Typeω, but we can infer their type.</a>
  <a id="6115" href="Meta.Copattern.html#6115" class="Bound">`U</a> <a id="6118" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="6120" href="Agda.Builtin.Reflection.html#8893" class="Postulate">infer-type</a> <a id="6131" href="Meta.Copattern.html#6028" class="Bound">`A</a>
  <a id="6136" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="6151" href="Agda.Builtin.Bool.html#198" class="InductiveConstructor">true</a> <a id="6156" href="Meta.Copattern.html#6016" class="Bound">nm</a> <a id="6159" href="Meta.Copattern.html#6028" class="Bound">`A</a> <a id="6162" href="Meta.Copattern.html#6115" class="Bound">`U</a>

<a id="define-copatternω"></a><a id="6166" href="Meta.Copattern.html#6166" class="Function">define-copatternω</a>
  <a id="6186" class="Symbol">:</a> <a id="6188" class="Symbol">(</a><a id="6189" href="Meta.Copattern.html#6189" class="Bound">nm</a> <a id="6192" class="Symbol">:</a> <a id="6194" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a><a id="6198" class="Symbol">)</a> <a id="6200" class="Symbol">{@(</a><a id="6203" class="Keyword">tactic</a> <a id="6210" class="Symbol">(</a><a id="6211" href="Meta.Copattern.html#4370" class="Function">type-for</a> <a id="6220" class="String">&quot;copatternω&quot;</a> <a id="6233" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="6239" href="Meta.Copattern.html#6189" class="Bound">nm</a><a id="6241" class="Symbol">))</a> <a id="6244" href="Meta.Copattern.html#6244" class="Bound">U</a> <a id="6246" class="Symbol">:</a> <a id="6248" href="Foundations.Prim.Type.html#349" class="Primitive">Typeω</a><a id="6253" class="Symbol">}</a>
  <a id="6257" class="Symbol">→</a> <a id="6259" href="Meta.Copattern.html#6244" class="Bound">U</a> <a id="6261" class="Symbol">→</a> <a id="6263" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="6266" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="6268" href="Meta.Copattern.html#6166" class="Function">define-copatternω</a> <a id="6286" href="Meta.Copattern.html#6286" class="Bound">nm</a> <a id="6289" href="Meta.Copattern.html#6289" class="Bound">A</a> <a id="6291" class="Symbol">=</a> <a id="6293" class="Keyword">do</a>
  <a id="6298" href="Meta.Copattern.html#6298" class="Bound">`U</a> <a id="6301" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="6303" href="Agda.Builtin.Reflection.html#9730" class="Postulate">get-type</a> <a id="6312" href="Meta.Copattern.html#6286" class="Bound">nm</a>
  <a id="6317" href="Meta.Copattern.html#6317" class="Bound">`A</a> <a id="6320" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="6322" href="Meta.Reflection.Signature.html#8336" class="Function">define-abbrev</a> <a id="6336" href="Meta.Copattern.html#6286" class="Bound">nm</a> <a id="6339" class="String">&quot;vlaue&quot;</a> <a id="6347" href="Meta.Copattern.html#6298" class="Bound">`U</a> <a id="6350" href="Meta.Effect.Bind.html#427" class="Function Operator">=&lt;&lt;</a> <a id="6354" href="Agda.Builtin.Reflection.html#9210" class="Postulate">quoteωTC</a> <a id="6363" href="Meta.Copattern.html#6289" class="Bound">A</a>
  <a id="6367" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="6382" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="6388" href="Meta.Copattern.html#6286" class="Bound">nm</a> <a id="6391" href="Meta.Copattern.html#6317" class="Bound">`A</a> <a id="6394" href="Meta.Copattern.html#6298" class="Bound">`U</a>

<a id="6398" class="Comment">{-
Another common pattern is that two records `r : R p` and `s : R q` may contain
the same data, but they are parameterized by different values.
The `define-eta-expansion` macro will automatically construct a function
`R p → R q` that eta-expands the first record out into a copattern definition.
-}</a>

<a id="define-eta-expansion"></a><a id="6699" href="Meta.Copattern.html#6699" class="Function">define-eta-expansion</a> <a id="6720" class="Symbol">:</a> <a id="6722" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="6727" class="Symbol">→</a> <a id="6729" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="6732" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="6734" href="Meta.Copattern.html#6699" class="Function">define-eta-expansion</a> <a id="6755" href="Meta.Copattern.html#6755" class="Bound">nm</a> <a id="6758" class="Symbol">=</a> <a id="6760" class="Keyword">do</a>
  <a id="6765" href="Meta.Copattern.html#6765" class="Bound">tp</a> <a id="6768" href="Meta.Effect.Bind.html#283" class="Field Operator">←</a> <a id="6770" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="6777" href="Meta.Effect.Bind.html#427" class="Function Operator">=&lt;&lt;</a> <a id="6781" href="Agda.Builtin.Reflection.html#8893" class="Postulate">infer-type</a> <a id="6792" class="Symbol">(</a><a id="6793" href="Data.Reflection.Term.html#2422" class="InductiveConstructor">def₀</a> <a id="6798" href="Meta.Copattern.html#6755" class="Bound">nm</a><a id="6800" class="Symbol">)</a>
  <a id="6804" class="Keyword">let</a> <a id="6808" href="Meta.Copattern.html#6808" class="Bound">tele</a> <a id="6813" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6815" class="Symbol">_</a> <a id="6817" class="Symbol">=</a> <a id="6819" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="6827" href="Meta.Copattern.html#6765" class="Bound">tp</a>
  <a id="6832" class="Keyword">let</a> <a id="6836" href="Meta.Copattern.html#6836" class="Bound">tm</a> <a id="6839" class="Symbol">=</a> <a id="6841" href="Data.Reflection.Term.html#1917" class="Function">tel→lam</a> <a id="6849" href="Meta.Copattern.html#6808" class="Bound">tele</a> <a id="6854" class="Symbol">(</a><a id="6855" href="Data.Reflection.Term.html#2448" class="InductiveConstructor">var₀</a> <a id="6860" class="Number">0</a><a id="6861" class="Symbol">)</a>
  <a id="6865" href="Meta.Copattern.html#917" class="Function">make-copattern</a> <a id="6880" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="6886" href="Meta.Copattern.html#6755" class="Bound">nm</a> <a id="6889" href="Meta.Copattern.html#6836" class="Bound">tm</a> <a id="6892" href="Meta.Copattern.html#6765" class="Bound">tp</a>

<a id="6896" class="Comment">--------------------------------------------------------------------------------</a>
<a id="6977" class="Comment">-- Tests</a>

<a id="6987" class="Keyword">private</a> <a id="6995" class="Keyword">module</a> <a id="Test"></a><a id="7002" href="Meta.Copattern.html#7002" class="Module">Test</a> <a id="7007" class="Keyword">where</a>
  <a id="7015" class="Comment">-- Record type that uses all interesting features.</a>
  <a id="7068" class="Keyword">record</a> <a id="Test.Record"></a><a id="7075" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="7082" class="Symbol">{</a><a id="7083" href="Meta.Copattern.html#7083" class="Bound">ℓ</a><a id="7084" class="Symbol">}</a> <a id="7086" class="Symbol">(</a><a id="7087" href="Meta.Copattern.html#7087" class="Bound">A</a> <a id="7089" class="Symbol">:</a> <a id="7091" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="7096" href="Meta.Copattern.html#7083" class="Bound">ℓ</a><a id="7097" class="Symbol">)</a> <a id="7099" class="Symbol">:</a> <a id="7101" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="7106" href="Meta.Copattern.html#7083" class="Bound">ℓ</a> <a id="7108" class="Keyword">where</a>
    <a id="7118" class="Keyword">no-eta-equality</a>
    <a id="7138" class="Keyword">constructor</a> <a id="Test.mk"></a><a id="7150" href="Meta.Copattern.html#7150" class="InductiveConstructor">mk</a>
    <a id="7157" class="Keyword">field</a>
      <a id="7169" class="Symbol">⦃</a> <a id="Test.Record.c"></a><a id="7171" href="Meta.Copattern.html#7171" class="Field">c</a> <a id="7173" class="Symbol">⦄</a> <a id="7175" class="Symbol">:</a> <a id="7177" href="Meta.Copattern.html#7087" class="Bound">A</a>
      <a id="7185" class="Symbol">{</a> <a id="Test.Record.f"></a><a id="7187" href="Meta.Copattern.html#7187" class="Field">f</a> <a id="7189" class="Symbol">}</a> <a id="7191" class="Symbol">:</a> <a id="7193" href="Meta.Copattern.html#7087" class="Bound">A</a> <a id="7195" class="Symbol">→</a> <a id="7197" href="Meta.Copattern.html#7087" class="Bound">A</a>
      <a id="Test.Record.const′"></a><a id="7205" href="Meta.Copattern.html#7205" class="Field">const′</a> <a id="7212" class="Symbol">:</a> <a id="7214" class="Symbol">∀</a> <a id="7216" class="Symbol">{</a><a id="7217" href="Meta.Copattern.html#7217" class="Bound">x</a><a id="7218" class="Symbol">}</a> <a id="7220" class="Symbol">→</a> <a id="7222" href="Meta.Copattern.html#7187" class="Field">f</a> <a id="7224" href="Meta.Copattern.html#7217" class="Bound">x</a> <a id="7226" href="Foundations.Prim.Kan.html#1264" class="Function Operator">＝</a> <a id="7228" href="Meta.Copattern.html#7171" class="Field">c</a>

  <a id="7233" class="Comment">-- Record created via a constructor.</a>
  <a id="Test.via-ctor"></a><a id="7272" href="Meta.Copattern.html#7272" class="Function">via-ctor</a> <a id="7281" class="Symbol">:</a> <a id="7283" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="7290" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="7294" href="Meta.Copattern.html#7272" class="Function">via-ctor</a> <a id="7303" class="Symbol">=</a> <a id="7305" href="Meta.Copattern.html#7150" class="InductiveConstructor">mk</a> <a id="7308" class="Symbol">⦃</a> <a id="7310" class="Argument">c</a> <a id="7312" class="Symbol">=</a> <a id="7314" class="Number">0</a> <a id="7316" class="Symbol">⦄</a> <a id="7318" class="Symbol">{</a><a id="7319" class="Argument">f</a> <a id="7321" class="Symbol">=</a> <a id="7323" class="Symbol">λ</a> <a id="7325" href="Meta.Copattern.html#7325" class="Bound">_</a> <a id="7327" class="Symbol">→</a> <a id="7329" class="Number">0</a><a id="7330" class="Symbol">}</a> <a id="7332" href="Foundations.Correspondences.Binary.Reflexive.html#337" class="Field">refl</a>

  <a id="7340" class="Comment">-- Both macros work.</a>
  <a id="7363" class="Keyword">unquoteDecl</a> <a id="Test.copat-decl-via-ctor"></a><a id="7375" href="Meta.Copattern.html#7375" class="Function">copat-decl-via-ctor</a> <a id="7395" class="Symbol">=</a> <a id="7397" href="Meta.Copattern.html#5350" class="Function">declare-copattern</a> <a id="7415" href="Meta.Copattern.html#7375" class="Function">copat-decl-via-ctor</a> <a id="7435" href="Meta.Copattern.html#7272" class="Function">via-ctor</a>

  <a id="Test.copat-def-via-ctor"></a><a id="7447" href="Meta.Copattern.html#7447" class="Function">copat-def-via-ctor</a> <a id="7466" class="Symbol">:</a> <a id="7468" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="7475" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="7479" class="Keyword">unquoteDef</a> <a id="7490" href="Meta.Copattern.html#7447" class="Function">copat-def-via-ctor</a> <a id="7509" class="Symbol">=</a> <a id="7511" href="Meta.Copattern.html#5509" class="Function">define-copattern</a> <a id="7528" href="Meta.Copattern.html#7447" class="Function">copat-def-via-ctor</a> <a id="7547" href="Meta.Copattern.html#7272" class="Function">via-ctor</a>

  <a id="7559" class="Comment">-- Record created by a function.</a>
  <a id="7594" class="Keyword">module</a> <a id="7601" href="Meta.Copattern.html#7601" class="Module">_</a> <a id="7603" class="Symbol">(</a><a id="7604" href="Meta.Copattern.html#7604" class="Bound">r</a> <a id="7606" class="Symbol">:</a> <a id="7608" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="7615" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="7616" class="Symbol">)</a> <a id="7618" class="Keyword">where</a>
    <a id="7628" class="Keyword">open</a> <a id="7633" href="Meta.Copattern.html#7075" class="Module">Record</a> <a id="7640" href="Meta.Copattern.html#7604" class="Bound">r</a>
    <a id="7646" href="Meta.Copattern.html#7646" class="Function">via-function</a> <a id="7659" class="Symbol">:</a> <a id="7661" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="7668" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
    <a id="7674" href="Meta.Copattern.html#7646" class="Function">via-function</a> <a id="7687" class="Symbol">.</a><a id="7688" href="Meta.Copattern.html#7171" class="Field">c</a> <a id="7690" class="Symbol">=</a> <a id="7692" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="7696" href="Meta.Copattern.html#7171" class="Field">c</a>
    <a id="7702" href="Meta.Copattern.html#7646" class="Function">via-function</a> <a id="7715" class="Symbol">.</a><a id="7716" href="Meta.Copattern.html#7187" class="Field">f</a> <a id="7718" class="Symbol">=</a> <a id="7720" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="7724" href="Foundations.Pi.Base.html#2101" class="Function Operator">∘</a> <a id="7726" href="Meta.Copattern.html#7187" class="Field">f</a>
    <a id="7732" href="Meta.Copattern.html#7646" class="Function">via-function</a> <a id="7745" class="Symbol">.</a><a id="7746" href="Meta.Copattern.html#7205" class="Field">const′</a> <a id="7753" class="Symbol">=</a> <a id="7755" href="Foundations.Prim.Kan.html#1724" class="Function">ap</a> <a id="7758" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="7762" href="Meta.Copattern.html#7205" class="Field">const′</a>

  <a id="7772" class="Comment">-- Also works when applied to the result of a function.</a>
  <a id="7830" class="Keyword">unquoteDecl</a> <a id="Test.copat-decl-via-function"></a><a id="7842" href="Meta.Copattern.html#7842" class="Function">copat-decl-via-function</a> <a id="7866" class="Symbol">=</a> <a id="7868" href="Meta.Copattern.html#5350" class="Function">declare-copattern</a> <a id="7886" href="Meta.Copattern.html#7842" class="Function">copat-decl-via-function</a> <a id="7910" class="Symbol">(</a><a id="7911" href="Meta.Copattern.html#7646" class="Function">via-function</a> <a id="7924" href="Meta.Copattern.html#7272" class="Function">via-ctor</a><a id="7932" class="Symbol">)</a>

  <a id="7937" class="Comment">-- Test to see how we handle unused parameters.</a>
  <a id="7987" class="Keyword">record</a> <a id="Test.Unused"></a><a id="7994" href="Meta.Copattern.html#7994" class="Record">Unused</a> <a id="8001" class="Symbol">(</a><a id="8002" href="Meta.Copattern.html#8002" class="Bound">n</a> <a id="8004" class="Symbol">:</a> <a id="8006" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="8007" class="Symbol">)</a> <a id="8009" class="Symbol">:</a> <a id="8011" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="8016" class="Keyword">where</a>
    <a id="8026" class="Keyword">field</a> <a id="Test.Unused.actual"></a><a id="8032" href="Meta.Copattern.html#8032" class="Field">actual</a> <a id="8039" class="Symbol">:</a> <a id="8041" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

  <a id="Test.zero-unused-param"></a><a id="8046" href="Meta.Copattern.html#8046" class="Function">zero-unused-param</a> <a id="8064" class="Symbol">:</a> <a id="8066" href="Meta.Copattern.html#7994" class="Record">Unused</a> <a id="8073" class="Number">0</a>
  <a id="8077" href="Meta.Copattern.html#8046" class="Function">zero-unused-param</a> <a id="8095" class="Symbol">=</a> <a id="8097" class="Keyword">record</a> <a id="8104" class="Symbol">{</a> <a id="8106" href="Meta.Copattern.html#8032" class="Field">actual</a> <a id="8113" class="Symbol">=</a> <a id="8115" class="Number">0</a> <a id="8117" class="Symbol">}</a>

  <a id="Test.one-unused-param"></a><a id="8122" href="Meta.Copattern.html#8122" class="Function">one-unused-param</a> <a id="8139" class="Symbol">:</a> <a id="8141" class="Symbol">∀</a> <a id="8143" class="Symbol">{</a><a id="8144" href="Meta.Copattern.html#8144" class="Bound">n</a><a id="8145" class="Symbol">}</a> <a id="8147" class="Symbol">→</a> <a id="8149" href="Meta.Copattern.html#7994" class="Record">Unused</a> <a id="8156" href="Meta.Copattern.html#8144" class="Bound">n</a>
  <a id="8160" class="Keyword">unquoteDef</a> <a id="8171" href="Meta.Copattern.html#8122" class="Function">one-unused-param</a> <a id="8188" class="Symbol">=</a> <a id="8190" href="Meta.Copattern.html#5350" class="Function">declare-copattern</a> <a id="8208" href="Meta.Copattern.html#8122" class="Function">one-unused-param</a> <a id="8225" href="Meta.Copattern.html#8046" class="Function">zero-unused-param</a>
  <a id="8245" class="Comment">-- This is a type error:</a>
  <a id="8272" class="Comment">-- unquoteDef one-unused-param = define-copattern one-unused-param zero-unused-param</a>
  <a id="8359" class="Comment">-- because the &#39;define&#39; macro propagates the type of the thing being</a>
  <a id="8430" class="Comment">-- defined inwards.</a>

  <a id="8453" class="Comment">-- Functions into records that are universe polymorphic</a>
  <a id="Test.neat"></a><a id="8511" href="Meta.Copattern.html#8511" class="Function">neat</a> <a id="8516" class="Symbol">:</a> <a id="8518" class="Symbol">∀</a> <a id="8520" class="Symbol">{</a><a id="8521" href="Meta.Copattern.html#8521" class="Bound">ℓ</a><a id="8522" class="Symbol">}</a> <a id="8524" class="Symbol">{</a><a id="8525" href="Meta.Copattern.html#8525" class="Bound">A</a> <a id="8527" class="Symbol">:</a> <a id="8529" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="8534" href="Meta.Copattern.html#8521" class="Bound">ℓ</a><a id="8535" class="Symbol">}</a> <a id="8537" class="Symbol">→</a> <a id="8539" href="Meta.Copattern.html#8525" class="Bound">A</a> <a id="8541" class="Symbol">→</a> <a id="8543" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="8550" href="Meta.Copattern.html#8525" class="Bound">A</a>
  <a id="8554" href="Meta.Copattern.html#8511" class="Function">neat</a> <a id="8559" href="Meta.Copattern.html#8559" class="Bound">a</a> <a id="8561" class="Symbol">.</a><a id="8562" href="Meta.Copattern.html#7171" class="Field">Record.c</a> <a id="8571" class="Symbol">=</a> <a id="8573" href="Meta.Copattern.html#8559" class="Bound">a</a>
  <a id="8577" href="Meta.Copattern.html#8511" class="Function">neat</a> <a id="8582" href="Meta.Copattern.html#8582" class="Bound">a</a> <a id="8584" class="Symbol">.</a><a id="8585" href="Meta.Copattern.html#7187" class="Field">Record.f</a> <a id="8594" class="Symbol">_</a> <a id="8596" class="Symbol">=</a> <a id="8598" href="Meta.Copattern.html#8582" class="Bound">a</a>
  <a id="8602" href="Meta.Copattern.html#8511" class="Function">neat</a> <a id="8607" href="Meta.Copattern.html#8607" class="Bound">a</a> <a id="8609" class="Symbol">.</a><a id="8610" href="Meta.Copattern.html#7205" class="Field">Record.const′</a> <a id="8624" class="Symbol">=</a> <a id="8626" href="Foundations.Correspondences.Binary.Reflexive.html#337" class="Field">refl</a>

  <a id="8634" class="Comment">-- Implicit insertion is correct for the define- macro, since the type</a>
  <a id="8707" class="Comment">-- of the function is given.</a>
  <a id="Test.cool"></a><a id="8738" href="Meta.Copattern.html#8738" class="Function">cool</a> <a id="8743" class="Symbol">:</a> <a id="8745" class="Symbol">∀</a> <a id="8747" class="Symbol">{</a><a id="8748" href="Meta.Copattern.html#8748" class="Bound">ℓ</a><a id="8749" class="Symbol">}</a> <a id="8751" class="Symbol">{</a><a id="8752" href="Meta.Copattern.html#8752" class="Bound">A</a> <a id="8754" class="Symbol">:</a> <a id="8756" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="8761" href="Meta.Copattern.html#8748" class="Bound">ℓ</a><a id="8762" class="Symbol">}</a> <a id="8764" class="Symbol">→</a> <a id="8766" href="Meta.Copattern.html#8752" class="Bound">A</a> <a id="8768" class="Symbol">→</a> <a id="8770" href="Meta.Copattern.html#7075" class="Record">Record</a> <a id="8777" href="Meta.Copattern.html#8752" class="Bound">A</a>
  <a id="8781" class="Keyword">unquoteDef</a> <a id="8792" href="Meta.Copattern.html#8738" class="Function">cool</a> <a id="8797" class="Symbol">=</a> <a id="8799" href="Meta.Copattern.html#6166" class="Function">define-copatternω</a> <a id="8817" href="Meta.Copattern.html#8738" class="Function">cool</a> <a id="8822" href="Meta.Copattern.html#8511" class="Function">neat</a>

  <a id="8830" class="Comment">-- Eta-expanders</a>
  <a id="Test.expander"></a><a id="8849" href="Meta.Copattern.html#8849" class="Function">expander</a> <a id="8858" class="Symbol">:</a> <a id="8860" class="Symbol">∀</a> <a id="8862" class="Symbol">{</a><a id="8863" href="Meta.Copattern.html#8863" class="Bound">m</a> <a id="8865" href="Meta.Copattern.html#8865" class="Bound">n</a> <a id="8867" class="Symbol">:</a> <a id="8869" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="8870" class="Symbol">}</a> <a id="8872" class="Symbol">→</a> <a id="8874" href="Meta.Copattern.html#7994" class="Record">Unused</a> <a id="8881" href="Meta.Copattern.html#8863" class="Bound">m</a> <a id="8883" class="Symbol">→</a> <a id="8885" href="Meta.Copattern.html#7994" class="Record">Unused</a> <a id="8892" href="Meta.Copattern.html#8865" class="Bound">n</a>
  <a id="8896" class="Keyword">unquoteDef</a> <a id="8907" href="Meta.Copattern.html#8849" class="Function">expander</a> <a id="8916" class="Symbol">=</a> <a id="8918" href="Meta.Copattern.html#6699" class="Function">define-eta-expansion</a> <a id="8939" href="Meta.Copattern.html#8849" class="Function">expander</a>

  <a id="8951" class="Comment">-- Raises a type error: the function should have a declaration.</a>
  <a id="9017" class="Comment">-- unquoteDecl uncool = define-copatternω uncool neat</a>
</pre></body></html>