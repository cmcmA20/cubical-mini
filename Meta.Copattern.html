<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Meta.Copattern</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Comment">-- Reed Mullanix 2024</a>
<a id="23" class="Symbol">{-#</a> <a id="27" class="Keyword">OPTIONS</a> <a id="35" class="Pragma">--safe</a> <a id="42" class="Pragma">--no-exact-split</a> <a id="59" class="Symbol">#-}</a>
<a id="63" class="Keyword">module</a> <a id="70" href="Meta.Copattern.html" class="Module">Meta.Copattern</a> <a id="85" class="Keyword">where</a>

<a id="92" class="Keyword">open</a> <a id="97" class="Keyword">import</a> <a id="104" href="Meta.Prelude.html" class="Module">Meta.Prelude</a>
<a id="117" class="Keyword">open</a> <a id="122" class="Keyword">import</a> <a id="129" href="Meta.Reflection.html" class="Module">Meta.Reflection</a>

<a id="146" class="Keyword">open</a> <a id="151" class="Keyword">import</a> <a id="158" href="Data.Bool.Base.html" class="Module">Data.Bool.Base</a>
<a id="173" class="Keyword">open</a> <a id="178" class="Keyword">import</a> <a id="185" href="Data.List.Base.html" class="Module">Data.List.Base</a>
<a id="200" class="Keyword">open</a> <a id="205" class="Keyword">import</a> <a id="212" href="Data.List.Operations.html" class="Module">Data.List.Operations</a>
<a id="233" class="Keyword">open</a> <a id="238" class="Keyword">import</a> <a id="245" href="Data.List.Instances.FromProduct.html" class="Module">Data.List.Instances.FromProduct</a>
<a id="277" class="Keyword">open</a> <a id="282" class="Keyword">import</a> <a id="289" href="Data.List.Instances.Traversable.html" class="Module">Data.List.Instances.Traversable</a>
<a id="321" class="Keyword">open</a> <a id="326" class="Keyword">import</a> <a id="333" href="Data.Reflection.Argument.html" class="Module">Data.Reflection.Argument</a>
<a id="358" class="Keyword">open</a> <a id="363" class="Keyword">import</a> <a id="370" href="Data.Reflection.Error.html" class="Module">Data.Reflection.Error</a>
<a id="392" class="Keyword">open</a> <a id="397" class="Keyword">import</a> <a id="404" href="Data.Reflection.Instances.FromString.html" class="Module">Data.Reflection.Instances.FromString</a>
<a id="441" class="Keyword">open</a> <a id="446" class="Keyword">import</a> <a id="453" href="Data.Reflection.Name.html" class="Module">Data.Reflection.Name</a>
<a id="474" class="Keyword">open</a> <a id="479" class="Keyword">import</a> <a id="486" href="Data.Reflection.Term.html" class="Module">Data.Reflection.Term</a>
<a id="507" class="Keyword">open</a> <a id="512" class="Keyword">import</a> <a id="519" href="Data.String.Base.html" class="Module">Data.String.Base</a>

<a id="537" class="Comment">--------------------------------------------------------------------------------</a>
<a id="618" class="Comment">-- Macros for manipulating copattern definitions.</a>

<a id="669" class="Comment">-- Make a top-level copattern binding for an existing record.</a>
<a id="make-copattern"></a><a id="731" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="746" class="Symbol">:</a> <a id="748" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="753" class="Symbol">→</a> <a id="755" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="760" class="Symbol">→</a> <a id="762" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="767" class="Symbol">→</a> <a id="769" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="774" class="Symbol">→</a> <a id="776" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="779" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="781" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="796" href="Meta.Copattern.html#796" class="Bound">declare?</a> <a id="805" href="Meta.Copattern.html#805" class="Bound">def-name</a> <a id="814" href="Meta.Copattern.html#814" class="Bound">tm</a> <a id="817" href="Meta.Copattern.html#817" class="Bound">tp</a> <a id="820" class="Symbol">=</a> <a id="822" class="Keyword">do</a>
  <a id="827" class="Comment">-- Ensure that codomain is a record type.</a>
  <a id="871" class="Keyword">let</a> <a id="875" href="Meta.Copattern.html#875" class="Bound">tele</a> <a id="880" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="882" href="Meta.Copattern.html#882" class="Bound">cod-tp</a> <a id="889" class="Symbol">=</a> <a id="891" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="899" href="Meta.Copattern.html#817" class="Bound">tp</a>
  <a id="904" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="908" href="Meta.Copattern.html#908" class="Bound">rec-name</a> <a id="917" href="Meta.Copattern.html#917" class="Bound">params</a> <a id="924" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="926" href="Meta.Effect.Idiom.html#381" class="Field">pure</a> <a id="931" href="Meta.Copattern.html#882" class="Bound">cod-tp</a>
    <a id="942" class="Keyword">where</a> <a id="948" class="CatchallClause Symbol">_</a> <a id="950" class="Symbol">→</a> <a id="952" href="Agda.Builtin.Reflection.html#8830" class="Postulate">type-error</a> <a id="963" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="965" class="String">&quot;make-copattern: codomain of &quot;</a> <a id="996" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="998" href="Data.Reflection.Error.html#191" class="InductiveConstructor">term-err</a> <a id="1007" href="Meta.Copattern.html#817" class="Bound">tp</a> <a id="1010" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1012" class="String">&quot; is not a record type.&quot;</a> <a id="1037" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a>

  <a id="1042" href="Meta.Copattern.html#1042" class="Bound">inst-tm</a> <a id="1050" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="1052" href="Meta.Reflection.Subst.html#8100" class="Function">apply*TC</a> <a id="1061" href="Meta.Copattern.html#814" class="Bound">tm</a> <a id="1064" class="Symbol">(</a><a id="1065" href="Meta.Reflection.Base.html#5205" class="Function">tel→args</a> <a id="1074" class="Number">0</a> <a id="1076" href="Meta.Copattern.html#875" class="Bound">tele</a><a id="1080" class="Symbol">)</a>

  <a id="1085" class="Comment">-- Construct copattern clauses for each field.</a>
  <a id="1134" href="Meta.Copattern.html#1134" class="Bound">ctor</a> <a id="1139" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1141" href="Meta.Copattern.html#1141" class="Bound">fields</a> <a id="1148" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="1150" href="Meta.Reflection.Signature.html#1415" class="Function">get-record-type</a> <a id="1166" href="Meta.Copattern.html#908" class="Bound">rec-name</a>
  <a id="1177" href="Meta.Copattern.html#1177" class="Bound">clauses</a> <a id="1185" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a>
    <a id="1191" href="Agda.Builtin.Reflection.html#9365" class="Postulate">in-context</a> <a id="1202" class="Symbol">(</a><a id="1203" href="Data.List.Base.html#955" class="Function">reverse-fast</a> <a id="1216" href="Meta.Copattern.html#875" class="Bound">tele</a><a id="1220" class="Symbol">)</a> <a id="1222" href="Meta.Notation.Underlying.html#1747" class="Function Operator">$</a>
      <a id="1230" href="Meta.Effect.Traversable.html#418" class="Function">for</a> <a id="1234" href="Meta.Copattern.html#1141" class="Bound">fields</a> <a id="1241" class="Symbol">λ</a> <a id="1243" class="Keyword">where</a> <a id="1249" class="Symbol">(</a><a id="1250" href="Agda.Builtin.Reflection.html#3732" class="InductiveConstructor">arg</a> <a id="1254" href="Meta.Copattern.html#1254" class="Bound">field-info</a> <a id="1265" href="Meta.Copattern.html#1265" class="Bound">field-name</a><a id="1275" class="Symbol">)</a> <a id="1277" class="Symbol">→</a> <a id="1279" class="Keyword">do</a>
      <a id="1288" class="Comment">-- Infer the type of the field with all known arguments instantiated.</a>
      <a id="1364" href="Meta.Copattern.html#1364" class="Bound">field-tp</a> <a id="1373" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="1375" href="Agda.Builtin.Reflection.html#8893" class="Postulate">infer-type</a> <a id="1386" class="Symbol">(</a><a id="1387" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="1391" href="Meta.Copattern.html#1265" class="Bound">field-name</a> <a id="1402" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="1404" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="1409" href="Meta.Copattern.html#1042" class="Bound">inst-tm</a> <a id="1417" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a><a id="1418" class="Symbol">)</a>

      <a id="1427" class="Comment">-- Agda will insert implicits when defining copatterns even</a>
      <a id="1493" class="Comment">-- with &#39;withExpandLast true&#39;, so we need to do implicit instantiation</a>
      <a id="1570" class="Comment">-- by hand. There are also cases where it&#39;s better to fully</a>
      <a id="1636" class="Comment">-- eta-expand than not (e.g. the &#39;helper&#39; we&#39;re expanding has a</a>
      <a id="1706" class="Comment">-- field defined by lazy matching, which does not reduce unless</a>
      <a id="1776" class="Comment">-- applied, and would cause duplication of the big input term). So</a>
      <a id="1849" class="Comment">-- we fully eta-expand clauses here.</a>
      <a id="1892" class="Comment">-- First, we strip off all leading quantifiers from the field</a>
      <a id="1960" class="Comment">-- type.</a>
      <a id="1975" class="Keyword">let</a> <a id="1979" href="Meta.Copattern.html#1979" class="Bound">field-tele</a> <a id="1990" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1992" href="Meta.Copattern.html#1992" class="Bound">tp</a> <a id="1995" class="Symbol">=</a> <a id="1997" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="2005" href="Meta.Copattern.html#1364" class="Bound">field-tp</a>
          <a id="2024" href="Meta.Copattern.html#2024" class="Bound">nargs</a> <a id="2030" class="Symbol">=</a> <a id="2032" href="Data.List.Operations.html#962" class="Function">length</a> <a id="2039" href="Meta.Copattern.html#1979" class="Bound">field-tele</a>
          <a id="2060" href="Meta.Copattern.html#2060" class="Bound">clause-tele</a> <a id="2072" class="Symbol">=</a> <a id="2074" href="Meta.Copattern.html#875" class="Bound">tele</a> <a id="2079" href="Data.List.Base.html#725" class="Function Operator">++</a> <a id="2082" href="Meta.Copattern.html#1979" class="Bound">field-tele</a>

      <a id="2100" class="Comment">-- Construct the pattern portion of the clause, making sure to bind</a>
      <a id="2174" class="Comment">-- all implicit variables. Note that copattern projections are always visible.</a>
      <a id="2259" class="Keyword">let</a> <a id="2263" href="Meta.Copattern.html#2263" class="Bound">pat</a> <a id="2267" class="Symbol">=</a>
            <a id="2281" href="Meta.Reflection.Base.html#5054" class="Function">tel→pats</a> <a id="2290" href="Meta.Copattern.html#2024" class="Bound">nargs</a> <a id="2296" href="Meta.Copattern.html#875" class="Bound">tele</a> <a id="2301" href="Data.List.Base.html#725" class="Function Operator">++</a>
            <a id="2316" href="Agda.Builtin.Reflection.html#3732" class="InductiveConstructor">arg</a> <a id="2320" class="Symbol">(</a><a id="2321" href="Meta.Reflection.Argument.html#345" class="Field">set-visibility</a> <a id="2336" href="Agda.Builtin.Reflection.html#2762" class="InductiveConstructor">visible</a> <a id="2344" href="Meta.Copattern.html#1254" class="Bound">field-info</a><a id="2354" class="Symbol">)</a> <a id="2356" class="Symbol">(</a><a id="2357" href="Agda.Builtin.Reflection.html#5977" class="InductiveConstructor">proj</a> <a id="2362" href="Meta.Copattern.html#1265" class="Bound">field-name</a><a id="2372" class="Symbol">)</a> <a id="2374" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a>
            <a id="2388" href="Meta.Reflection.Base.html#5054" class="Function">tel→pats</a> <a id="2397" class="Number">0</a> <a id="2399" href="Meta.Copattern.html#1979" class="Bound">field-tele</a>

      <a id="2417" class="Comment">-- Construct the body of the clause, making sure to apply all</a>
      <a id="2485" class="Comment">-- arguments bound outside the copattern match, and apply the</a>
      <a id="2553" class="Comment">-- eta-expanded arguments. We also need to apply all of the</a>
      <a id="2619" class="Comment">-- implicit arguments to &#39;tm&#39;.</a>
      <a id="2656" href="Meta.Copattern.html#2656" class="Bound">zz</a> <a id="2659" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="2661" href="Meta.Reflection.Subst.html#7597" class="Function">raiseTC</a> <a id="2669" href="Meta.Copattern.html#2024" class="Bound">nargs</a> <a id="2675" href="Meta.Copattern.html#1042" class="Bound">inst-tm</a>
      <a id="2689" href="Meta.Copattern.html#2689" class="Bound">body</a> <a id="2694" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a>
        <a id="2704" href="Agda.Builtin.Reflection.html#9365" class="Postulate">in-context</a> <a id="2715" class="Symbol">(</a><a id="2716" href="Data.List.Base.html#866" class="Function">reverse</a> <a id="2724" href="Meta.Copattern.html#2060" class="Bound">clause-tele</a><a id="2735" class="Symbol">)</a> <a id="2737" href="Meta.Notation.Underlying.html#1747" class="Function Operator">$</a>
        <a id="2747" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="2754" class="Symbol">(</a><a id="2755" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="2759" href="Meta.Copattern.html#1265" class="Bound">field-name</a> <a id="2770" class="Symbol">(</a><a id="2771" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="2776" href="Meta.Copattern.html#2656" class="Bound">zz</a> <a id="2779" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="2781" href="Meta.Reflection.Base.html#5205" class="Function">tel→args</a> <a id="2790" class="Number">0</a> <a id="2792" href="Meta.Copattern.html#1979" class="Bound">field-tele</a><a id="2802" class="Symbol">))</a>

      <a id="2812" class="Comment">-- Construct the final clause.</a>
      <a id="2849" href="Meta.Effect.Idiom.html#381" class="Field">pure</a> <a id="2854" href="Meta.Notation.Underlying.html#1747" class="Function Operator">$</a> <a id="2856" href="Agda.Builtin.Reflection.html#6106" class="InductiveConstructor">clause</a> <a id="2863" href="Meta.Copattern.html#2060" class="Bound">clause-tele</a> <a id="2875" href="Meta.Copattern.html#2263" class="Bound">pat</a> <a id="2879" href="Meta.Copattern.html#2689" class="Bound">body</a>

  <a id="2887" class="Comment">-- Define a copattern binding, and predeclare its type if required.</a>
  <a id="2957" href="Meta.Effect.Idiom.html#560" class="Function">when</a> <a id="2962" href="Meta.Copattern.html#796" class="Bound">declare?</a> <a id="2971" class="Keyword">do</a>
    <a id="2978" href="Agda.Builtin.Reflection.html#9468" class="Postulate">declare-def</a> <a id="2990" class="Symbol">(</a><a id="2991" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="2996" href="Meta.Copattern.html#805" class="Bound">def-name</a><a id="3004" class="Symbol">)</a> <a id="3006" href="Meta.Copattern.html#817" class="Bound">tp</a> <a id="3009" href="Meta.Effect.Alt.html#342" class="Field Operator">&lt;|&gt;</a> <a id="3013" href="Meta.Effect.Idiom.html#381" class="Field">pure</a> <a id="3018" href="Agda.Builtin.Unit.html#212" class="InductiveConstructor">tt</a>

  <a id="3024" class="Comment">-- Construct the final copattern.</a>
  <a id="3060" href="Agda.Builtin.Reflection.html#9683" class="Postulate">define-function</a> <a id="3076" href="Meta.Copattern.html#805" class="Bound">def-name</a> <a id="3085" href="Meta.Copattern.html#1177" class="Bound">clauses</a>

<a id="3094" class="Comment">-- Repack a record type.</a>
<a id="3119" class="Comment">-- Will also accept functions into record types like `A → Record`,</a>
<a id="3186" class="Comment">-- and will perform a pointwise repacking.</a>
<a id="repack-record"></a><a id="3229" href="Meta.Copattern.html#3229" class="Function">repack-record</a> <a id="3243" class="Symbol">:</a> <a id="3245" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="3250" class="Symbol">→</a> <a id="3252" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="3257" class="Symbol">→</a> <a id="3259" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="3262" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a>
<a id="3267" href="Meta.Copattern.html#3229" class="Function">repack-record</a> <a id="3281" href="Meta.Copattern.html#3281" class="Bound">tm</a> <a id="3284" href="Meta.Copattern.html#3284" class="Bound">tp</a> <a id="3287" class="Symbol">=</a> <a id="3289" class="Keyword">do</a>
  <a id="3294" class="Comment">-- Ensure that codomain is a record type.</a>
  <a id="3338" href="Meta.Copattern.html#3338" class="Bound">tele</a> <a id="3343" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3345" href="Meta.Copattern.html#3345" class="Bound">cod-tp</a> <a id="3352" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="3354" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="3362" href="Meta.Effect.Map.Base.html#411" class="Function Operator">&lt;$&gt;</a> <a id="3366" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="3373" href="Meta.Copattern.html#3284" class="Bound">tp</a>
  <a id="3378" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="3382" href="Meta.Copattern.html#3382" class="Bound">rec-name</a> <a id="3391" href="Meta.Copattern.html#3391" class="Bound">params</a> <a id="3398" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="3400" href="Meta.Effect.Idiom.html#381" class="Field">pure</a> <a id="3405" href="Meta.Copattern.html#3345" class="Bound">cod-tp</a>
    <a id="3416" class="Keyword">where</a> <a id="3422" class="CatchallClause Symbol">_</a> <a id="3424" class="Symbol">→</a> <a id="3426" href="Agda.Builtin.Reflection.html#8830" class="Postulate">type-error</a> <a id="3437" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="3439" class="String">&quot;repack-record: codomain of &quot;</a> <a id="3469" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3471" href="Data.Reflection.Error.html#191" class="InductiveConstructor">term-err</a> <a id="3480" href="Meta.Copattern.html#3284" class="Bound">tp</a> <a id="3483" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3485" class="String">&quot; is not a record type.&quot;</a> <a id="3510" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a>

  <a id="3515" class="Comment">-- Instantiate the term with all telescope arguments to saturate it.</a>
  <a id="3586" href="Meta.Copattern.html#3586" class="Bound">inst-tm</a> <a id="3594" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="3596" href="Meta.Reflection.Subst.html#8100" class="Function">apply*TC</a> <a id="3605" href="Meta.Copattern.html#3281" class="Bound">tm</a> <a id="3608" class="Symbol">(</a><a id="3609" href="Meta.Reflection.Base.html#5205" class="Function">tel→args</a> <a id="3618" class="Number">0</a> <a id="3620" href="Meta.Copattern.html#3338" class="Bound">tele</a><a id="3624" class="Symbol">)</a>

  <a id="3629" class="Comment">-- Construct fields for each projection.</a>
  <a id="3672" href="Meta.Copattern.html#3672" class="Bound">ctor</a> <a id="3677" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3679" href="Meta.Copattern.html#3679" class="Bound">fields</a> <a id="3686" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="3688" href="Meta.Reflection.Signature.html#1415" class="Function">get-record-type</a> <a id="3704" href="Meta.Copattern.html#3382" class="Bound">rec-name</a>
  <a id="3715" href="Meta.Copattern.html#3715" class="Bound">args</a> <a id="3720" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="3722" href="Agda.Builtin.Reflection.html#9365" class="Postulate">in-context</a> <a id="3733" class="Symbol">(</a><a id="3734" href="Data.List.Base.html#955" class="Function">reverse-fast</a> <a id="3747" href="Meta.Copattern.html#3338" class="Bound">tele</a><a id="3751" class="Symbol">)</a> <a id="3753" href="Meta.Notation.Underlying.html#1747" class="Function Operator">$</a>
    <a id="3759" href="Meta.Effect.Traversable.html#418" class="Function">for</a> <a id="3763" href="Meta.Copattern.html#3679" class="Bound">fields</a> <a id="3770" class="Symbol">λ</a> <a id="3772" class="Keyword">where</a> <a id="3778" class="Symbol">(</a><a id="3779" href="Agda.Builtin.Reflection.html#3732" class="InductiveConstructor">arg</a> <a id="3783" href="Meta.Copattern.html#3783" class="Bound">field-info</a> <a id="3794" href="Meta.Copattern.html#3794" class="Bound">field-name</a><a id="3804" class="Symbol">)</a> <a id="3806" class="Symbol">→</a>
                         <a id="3833" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="3838" href="Meta.Effect.Map.Base.html#411" class="Function Operator">&lt;$&gt;</a> <a id="3842" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="3849" class="Symbol">(</a><a id="3850" href="Agda.Builtin.Reflection.html#5251" class="InductiveConstructor">def</a> <a id="3854" href="Meta.Copattern.html#3794" class="Bound">field-name</a> <a id="3865" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="3867" href="Data.Reflection.Argument.html#1588" class="Function">argN</a> <a id="3872" href="Meta.Copattern.html#3586" class="Bound">inst-tm</a> <a id="3880" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a><a id="3881" class="Symbol">)</a>

  <a id="3886" class="Comment">-- Builld a pointwise repacking.</a>
  <a id="3921" href="Meta.Effect.Idiom.html#381" class="Field">pure</a> <a id="3926" class="Symbol">(</a><a id="3927" href="Data.Reflection.Term.html#1917" class="Function">tel→lam</a> <a id="3935" href="Meta.Copattern.html#3338" class="Bound">tele</a> <a id="3940" class="Symbol">(</a><a id="3941" href="Agda.Builtin.Reflection.html#5194" class="InductiveConstructor">con</a> <a id="3945" href="Meta.Copattern.html#3672" class="Bound">ctor</a> <a id="3950" href="Meta.Copattern.html#3715" class="Bound">args</a><a id="3954" class="Symbol">))</a>

<a id="3958" class="Comment">-- Helper for the &#39;define&#39; macros; Unifies the given goal with the type</a>
<a id="4030" class="Comment">-- of the given function, if it has been defined. If the function has</a>
<a id="4100" class="Comment">-- not been defined, and the first argument is &#39;false&#39;, then an error is</a>
<a id="4173" class="Comment">-- raised.</a>
<a id="type-for"></a><a id="4184" href="Meta.Copattern.html#4184" class="Function">type-for</a> <a id="4193" class="Symbol">:</a> <a id="4195" href="Agda.Builtin.String.html#335" class="Postulate">String</a> <a id="4202" class="Symbol">→</a> <a id="4204" href="Agda.Builtin.Bool.html#173" class="Datatype">Bool</a> <a id="4209" class="Symbol">→</a> <a id="4211" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="4216" class="Symbol">→</a> <a id="4218" href="Agda.Builtin.Reflection.html#4993" class="Datatype">Term</a> <a id="4223" class="Symbol">→</a> <a id="4225" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="4228" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="4230" href="Meta.Copattern.html#4184" class="Function">type-for</a> <a id="4239" href="Meta.Copattern.html#4239" class="Bound">tac</a> <a id="4243" href="Meta.Copattern.html#4243" class="Bound">decl?</a> <a id="4249" href="Meta.Copattern.html#4249" class="Bound">fun</a> <a id="4253" href="Meta.Copattern.html#4253" class="Bound">goal</a> <a id="4258" class="Symbol">=</a> <a id="4260" class="Symbol">(</a><a id="4261" href="Agda.Builtin.Reflection.html#9730" class="Postulate">get-type</a> <a id="4270" href="Meta.Copattern.html#4249" class="Bound">fun</a> <a id="4274" href="Meta.Effect.Bind.html#305" class="Field Operator">&gt;&gt;=</a> <a id="4278" href="Agda.Builtin.Reflection.html#8790" class="Postulate">unify</a> <a id="4284" href="Meta.Copattern.html#4253" class="Bound">goal</a><a id="4288" class="Symbol">)</a> <a id="4290" href="Meta.Effect.Alt.html#342" class="Field Operator">&lt;|&gt;</a> <a id="4294" class="Keyword">do</a>
  <a id="4299" href="Meta.Effect.Idiom.html#635" class="Function">unless</a> <a id="4306" href="Meta.Copattern.html#4243" class="Bound">decl?</a> <a id="4312" href="Meta.Notation.Underlying.html#1747" class="Function Operator">$</a> <a id="4314" href="Agda.Builtin.Reflection.html#8830" class="Postulate">type-error</a>
    <a id="4329" href="Meta.Literals.FromProduct.html#385" class="Function Operator">[</a> <a id="4331" class="String">&quot;define-&quot;</a> <a id="4341" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4343" href="Data.Reflection.Error.html#159" class="InductiveConstructor">str-err</a> <a id="4351" href="Meta.Copattern.html#4239" class="Bound">tac</a> <a id="4355" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4357" class="String">&quot;: the function &quot;</a>
    <a id="4379" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4381" href="Data.Reflection.Error.html#256" class="InductiveConstructor">name-err</a> <a id="4390" href="Meta.Copattern.html#4249" class="Bound">fun</a> <a id="4394" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4396" class="String">&quot; should already have been declared.&quot;</a>
    <a id="4438" href="Meta.Literals.FromProduct.html#385" class="Function Operator">]</a>


<a id="4442" class="Comment">--------------------------------------------------------------------------------</a>
<a id="4523" class="Comment">-- Usage</a>

<a id="4533" class="Comment">{-
Write the following in a module:
&gt;  unquoteDecl copat = declare-copattern copat thing-to-be-expanded
If you wish to give the binding a type annotation, you can also use
&gt;  copat : Your-type
&gt;  unquoteDecl copat = declare-copattern copat thing-to-be-expanded
All features of non-recursive records are supported, including instance
fields and fields with implicit arguments.
These macros also allow you to lift functions &#39;A → some-record-type&#39;
into copattern definitions. Note that Agda will generate meta for
implicits before performing quotation, so we need to explicitly
bind all implicits using a lambda before quotation!
-}</a>

<a id="declare-copattern"></a><a id="5164" href="Meta.Copattern.html#5164" class="Function">declare-copattern</a> <a id="5182" class="Symbol">:</a> <a id="5184" class="Symbol">∀</a> <a id="5186" class="Symbol">{</a><a id="5187" href="Meta.Copattern.html#5187" class="Bound">ℓ</a><a id="5188" class="Symbol">}</a> <a id="5190" class="Symbol">{</a><a id="5191" href="Meta.Copattern.html#5191" class="Bound">A</a> <a id="5193" class="Symbol">:</a> <a id="5195" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="5200" href="Meta.Copattern.html#5187" class="Bound">ℓ</a><a id="5201" class="Symbol">}</a> <a id="5203" class="Symbol">→</a> <a id="5205" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="5210" class="Symbol">→</a> <a id="5212" href="Meta.Copattern.html#5191" class="Bound">A</a> <a id="5214" class="Symbol">→</a> <a id="5216" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="5219" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5221" href="Meta.Copattern.html#5164" class="Function">declare-copattern</a> <a id="5239" class="Symbol">{</a><a id="5240" class="Argument">A</a> <a id="5242" class="Symbol">=</a> <a id="5244" href="Meta.Copattern.html#5244" class="Bound">A</a><a id="5245" class="Symbol">}</a> <a id="5247" href="Meta.Copattern.html#5247" class="Bound">nm</a> <a id="5250" href="Meta.Copattern.html#5250" class="Bound">x</a> <a id="5252" class="Symbol">=</a> <a id="5254" class="Keyword">do</a>
  <a id="5259" href="Meta.Copattern.html#5259" class="Bound">`x</a> <a id="5262" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="5264" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5272" href="Meta.Copattern.html#5250" class="Bound">x</a>
  <a id="5276" href="Meta.Copattern.html#5276" class="Bound">`A</a> <a id="5279" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="5281" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5289" href="Meta.Copattern.html#5244" class="Bound">A</a>
  <a id="5293" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="5308" href="Agda.Builtin.Bool.html#198" class="InductiveConstructor">true</a> <a id="5313" href="Meta.Copattern.html#5247" class="Bound">nm</a> <a id="5316" href="Meta.Copattern.html#5259" class="Bound">`x</a> <a id="5319" href="Meta.Copattern.html#5276" class="Bound">`A</a>

<a id="define-copattern"></a><a id="5323" href="Meta.Copattern.html#5323" class="Function">define-copattern</a>
  <a id="5342" class="Symbol">:</a> <a id="5344" class="Symbol">∀</a> <a id="5346" class="Symbol">{</a><a id="5347" href="Meta.Copattern.html#5347" class="Bound">ℓ</a><a id="5348" class="Symbol">}</a> <a id="5350" class="Symbol">(</a><a id="5351" href="Meta.Copattern.html#5351" class="Bound">nm</a> <a id="5354" class="Symbol">:</a> <a id="5356" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a><a id="5360" class="Symbol">)</a>
  <a id="5364" class="Symbol">→</a> <a id="5366" class="Symbol">{@(</a><a id="5369" class="Keyword">tactic</a> <a id="5376" class="Symbol">(</a><a id="5377" href="Meta.Copattern.html#4184" class="Function">type-for</a> <a id="5386" class="String">&quot;copattern&quot;</a> <a id="5398" href="Agda.Builtin.Bool.html#198" class="InductiveConstructor">true</a> <a id="5403" href="Meta.Copattern.html#5351" class="Bound">nm</a><a id="5405" class="Symbol">))</a> <a id="5408" href="Meta.Copattern.html#5408" class="Bound">A</a> <a id="5410" class="Symbol">:</a> <a id="5412" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="5417" href="Meta.Copattern.html#5347" class="Bound">ℓ</a><a id="5418" class="Symbol">}</a>
  <a id="5422" class="Symbol">→</a> <a id="5424" href="Meta.Copattern.html#5408" class="Bound">A</a> <a id="5426" class="Symbol">→</a> <a id="5428" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="5431" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5433" href="Meta.Copattern.html#5323" class="Function">define-copattern</a> <a id="5450" href="Meta.Copattern.html#5450" class="Bound">nm</a> <a id="5453" class="Symbol">{</a><a id="5454" href="Meta.Copattern.html#5454" class="Bound">A</a><a id="5455" class="Symbol">}</a> <a id="5457" href="Meta.Copattern.html#5457" class="Bound">x</a> <a id="5459" class="Symbol">=</a> <a id="5461" class="Keyword">do</a>
  <a id="5466" href="Meta.Copattern.html#5466" class="Bound">`A</a> <a id="5469" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="5471" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5479" href="Meta.Copattern.html#5454" class="Bound">A</a>
  <a id="5483" href="Meta.Copattern.html#5483" class="Bound">`x</a> <a id="5486" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="5488" href="Meta.Reflection.Signature.html#8336" class="Function">define-abbrev</a> <a id="5502" href="Meta.Copattern.html#5450" class="Bound">nm</a> <a id="5505" class="String">&quot;value&quot;</a> <a id="5513" href="Meta.Copattern.html#5466" class="Bound">`A</a> <a id="5516" href="Meta.Effect.Bind.html#449" class="Function Operator">=&lt;&lt;</a> <a id="5520" href="Agda.Builtin.Reflection.html#9104" class="Postulate">quoteTC</a> <a id="5528" href="Meta.Copattern.html#5457" class="Bound">x</a>
  <a id="5532" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="5547" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="5553" href="Meta.Copattern.html#5450" class="Bound">nm</a> <a id="5556" href="Meta.Copattern.html#5483" class="Bound">`x</a> <a id="5559" href="Meta.Copattern.html#5466" class="Bound">`A</a>

<a id="5563" class="Comment">{-
There is a slight caveat with level-polymorphic defintions, as
they cannot be quoted into any `Type ℓ`. With this in mind,
we also provide a pair of macros that work over `Typeω` instead.
-}</a>

<a id="declare-copatternω"></a><a id="5758" href="Meta.Copattern.html#5758" class="Function">declare-copatternω</a> <a id="5777" class="Symbol">:</a> <a id="5779" class="Symbol">∀</a> <a id="5781" class="Symbol">{</a><a id="5782" href="Meta.Copattern.html#5782" class="Bound">U</a> <a id="5784" class="Symbol">:</a> <a id="5786" href="Foundations.Prim.Type.html#349" class="Primitive">Typeω</a><a id="5791" class="Symbol">}</a> <a id="5793" class="Symbol">→</a> <a id="5795" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="5800" class="Symbol">→</a> <a id="5802" href="Meta.Copattern.html#5782" class="Bound">U</a> <a id="5804" class="Symbol">→</a> <a id="5806" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="5809" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="5811" href="Meta.Copattern.html#5758" class="Function">declare-copatternω</a> <a id="5830" href="Meta.Copattern.html#5830" class="Bound">nm</a> <a id="5833" href="Meta.Copattern.html#5833" class="Bound">A</a> <a id="5835" class="Symbol">=</a> <a id="5837" class="Keyword">do</a>
  <a id="5842" href="Meta.Copattern.html#5842" class="Bound">`A</a> <a id="5845" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="5847" href="Agda.Builtin.Reflection.html#9210" class="Postulate">quoteωTC</a> <a id="5856" href="Meta.Copattern.html#5833" class="Bound">A</a>
  <a id="5860" class="Comment">-- Cannot quote things in type Typeω, but we can infer their type.</a>
  <a id="5929" href="Meta.Copattern.html#5929" class="Bound">`U</a> <a id="5932" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="5934" href="Agda.Builtin.Reflection.html#8893" class="Postulate">infer-type</a> <a id="5945" href="Meta.Copattern.html#5842" class="Bound">`A</a>
  <a id="5950" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="5965" href="Agda.Builtin.Bool.html#198" class="InductiveConstructor">true</a> <a id="5970" href="Meta.Copattern.html#5830" class="Bound">nm</a> <a id="5973" href="Meta.Copattern.html#5842" class="Bound">`A</a> <a id="5976" href="Meta.Copattern.html#5929" class="Bound">`U</a>

<a id="define-copatternω"></a><a id="5980" href="Meta.Copattern.html#5980" class="Function">define-copatternω</a>
  <a id="6000" class="Symbol">:</a> <a id="6002" class="Symbol">(</a><a id="6003" href="Meta.Copattern.html#6003" class="Bound">nm</a> <a id="6006" class="Symbol">:</a> <a id="6008" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a><a id="6012" class="Symbol">)</a> <a id="6014" class="Symbol">{@(</a><a id="6017" class="Keyword">tactic</a> <a id="6024" class="Symbol">(</a><a id="6025" href="Meta.Copattern.html#4184" class="Function">type-for</a> <a id="6034" class="String">&quot;copatternω&quot;</a> <a id="6047" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="6053" href="Meta.Copattern.html#6003" class="Bound">nm</a><a id="6055" class="Symbol">))</a> <a id="6058" href="Meta.Copattern.html#6058" class="Bound">U</a> <a id="6060" class="Symbol">:</a> <a id="6062" href="Foundations.Prim.Type.html#349" class="Primitive">Typeω</a><a id="6067" class="Symbol">}</a>
  <a id="6071" class="Symbol">→</a> <a id="6073" href="Meta.Copattern.html#6058" class="Bound">U</a> <a id="6075" class="Symbol">→</a> <a id="6077" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="6080" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="6082" href="Meta.Copattern.html#5980" class="Function">define-copatternω</a> <a id="6100" href="Meta.Copattern.html#6100" class="Bound">nm</a> <a id="6103" href="Meta.Copattern.html#6103" class="Bound">A</a> <a id="6105" class="Symbol">=</a> <a id="6107" class="Keyword">do</a>
  <a id="6112" href="Meta.Copattern.html#6112" class="Bound">`U</a> <a id="6115" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="6117" href="Agda.Builtin.Reflection.html#9730" class="Postulate">get-type</a> <a id="6126" href="Meta.Copattern.html#6100" class="Bound">nm</a>
  <a id="6131" href="Meta.Copattern.html#6131" class="Bound">`A</a> <a id="6134" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="6136" href="Meta.Reflection.Signature.html#8336" class="Function">define-abbrev</a> <a id="6150" href="Meta.Copattern.html#6100" class="Bound">nm</a> <a id="6153" class="String">&quot;vlaue&quot;</a> <a id="6161" href="Meta.Copattern.html#6112" class="Bound">`U</a> <a id="6164" href="Meta.Effect.Bind.html#449" class="Function Operator">=&lt;&lt;</a> <a id="6168" href="Agda.Builtin.Reflection.html#9210" class="Postulate">quoteωTC</a> <a id="6177" href="Meta.Copattern.html#6103" class="Bound">A</a>
  <a id="6181" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="6196" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="6202" href="Meta.Copattern.html#6100" class="Bound">nm</a> <a id="6205" href="Meta.Copattern.html#6131" class="Bound">`A</a> <a id="6208" href="Meta.Copattern.html#6112" class="Bound">`U</a>

<a id="6212" class="Comment">{-
Another common pattern is that two records `r : R p` and `s : R q` may contain
the same data, but they are parameterized by different values.
The `define-eta-expansion` macro will automatically construct a function
`R p → R q` that eta-expands the first record out into a copattern definition.
-}</a>

<a id="define-eta-expansion"></a><a id="6513" href="Meta.Copattern.html#6513" class="Function">define-eta-expansion</a> <a id="6534" class="Symbol">:</a> <a id="6536" href="Agda.Builtin.Reflection.html#488" class="Postulate">Name</a> <a id="6541" class="Symbol">→</a> <a id="6543" href="Agda.Builtin.Reflection.html#8617" class="Postulate">TC</a> <a id="6546" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>
<a id="6548" href="Meta.Copattern.html#6513" class="Function">define-eta-expansion</a> <a id="6569" href="Meta.Copattern.html#6569" class="Bound">nm</a> <a id="6572" class="Symbol">=</a> <a id="6574" class="Keyword">do</a>
  <a id="6579" href="Meta.Copattern.html#6579" class="Bound">tp</a> <a id="6582" href="Meta.Effect.Bind.html#305" class="Field Operator">←</a> <a id="6584" href="Agda.Builtin.Reflection.html#9008" class="Postulate">reduce</a> <a id="6591" href="Meta.Effect.Bind.html#449" class="Function Operator">=&lt;&lt;</a> <a id="6595" href="Agda.Builtin.Reflection.html#8893" class="Postulate">infer-type</a> <a id="6606" class="Symbol">(</a><a id="6607" href="Data.Reflection.Term.html#2422" class="InductiveConstructor">def₀</a> <a id="6612" href="Meta.Copattern.html#6569" class="Bound">nm</a><a id="6614" class="Symbol">)</a>
  <a id="6618" class="Keyword">let</a> <a id="6622" href="Meta.Copattern.html#6622" class="Bound">tele</a> <a id="6627" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6629" class="Symbol">_</a> <a id="6631" class="Symbol">=</a> <a id="6633" href="Data.Reflection.Term.html#1449" class="Function">pi-view</a> <a id="6641" href="Meta.Copattern.html#6579" class="Bound">tp</a>
  <a id="6646" class="Keyword">let</a> <a id="6650" href="Meta.Copattern.html#6650" class="Bound">tm</a> <a id="6653" class="Symbol">=</a> <a id="6655" href="Data.Reflection.Term.html#1917" class="Function">tel→lam</a> <a id="6663" href="Meta.Copattern.html#6622" class="Bound">tele</a> <a id="6668" class="Symbol">(</a><a id="6669" href="Data.Reflection.Term.html#2448" class="InductiveConstructor">var₀</a> <a id="6674" class="Number">0</a><a id="6675" class="Symbol">)</a>
  <a id="6679" href="Meta.Copattern.html#731" class="Function">make-copattern</a> <a id="6694" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="6700" href="Meta.Copattern.html#6569" class="Bound">nm</a> <a id="6703" href="Meta.Copattern.html#6650" class="Bound">tm</a> <a id="6706" href="Meta.Copattern.html#6579" class="Bound">tp</a>

<a id="6710" class="Comment">--------------------------------------------------------------------------------</a>
<a id="6791" class="Comment">-- Tests</a>

<a id="6801" class="Keyword">private</a> <a id="6809" class="Keyword">module</a> <a id="Test"></a><a id="6816" href="Meta.Copattern.html#6816" class="Module">Test</a> <a id="6821" class="Keyword">where</a>
  <a id="6829" class="Comment">-- Record type that uses all interesting features.</a>
  <a id="6882" class="Keyword">record</a> <a id="Test.Record"></a><a id="6889" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="6896" class="Symbol">{</a><a id="6897" href="Meta.Copattern.html#6897" class="Bound">ℓ</a><a id="6898" class="Symbol">}</a> <a id="6900" class="Symbol">(</a><a id="6901" href="Meta.Copattern.html#6901" class="Bound">A</a> <a id="6903" class="Symbol">:</a> <a id="6905" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="6910" href="Meta.Copattern.html#6897" class="Bound">ℓ</a><a id="6911" class="Symbol">)</a> <a id="6913" class="Symbol">:</a> <a id="6915" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="6920" href="Meta.Copattern.html#6897" class="Bound">ℓ</a> <a id="6922" class="Keyword">where</a>
    <a id="6932" class="Keyword">no-eta-equality</a>
    <a id="6952" class="Keyword">constructor</a> <a id="Test.mk"></a><a id="6964" href="Meta.Copattern.html#6964" class="InductiveConstructor">mk</a>
    <a id="6971" class="Keyword">field</a>
      <a id="6983" class="Symbol">⦃</a> <a id="Test.Record.c"></a><a id="6985" href="Meta.Copattern.html#6985" class="Field">c</a> <a id="6987" class="Symbol">⦄</a> <a id="6989" class="Symbol">:</a> <a id="6991" href="Meta.Copattern.html#6901" class="Bound">A</a>
      <a id="6999" class="Symbol">{</a> <a id="Test.Record.f"></a><a id="7001" href="Meta.Copattern.html#7001" class="Field">f</a> <a id="7003" class="Symbol">}</a> <a id="7005" class="Symbol">:</a> <a id="7007" href="Meta.Copattern.html#6901" class="Bound">A</a> <a id="7009" class="Symbol">→</a> <a id="7011" href="Meta.Copattern.html#6901" class="Bound">A</a>
      <a id="Test.Record.const′"></a><a id="7019" href="Meta.Copattern.html#7019" class="Field">const′</a> <a id="7026" class="Symbol">:</a> <a id="7028" class="Symbol">∀</a> <a id="7030" class="Symbol">{</a><a id="7031" href="Meta.Copattern.html#7031" class="Bound">x</a><a id="7032" class="Symbol">}</a> <a id="7034" class="Symbol">→</a> <a id="7036" href="Meta.Copattern.html#7001" class="Field">f</a> <a id="7038" href="Meta.Copattern.html#7031" class="Bound">x</a> <a id="7040" href="Foundations.Prim.Kan.html#1264" class="Function Operator">＝</a> <a id="7042" href="Meta.Copattern.html#6985" class="Field">c</a>

  <a id="7047" class="Comment">-- Record created via a constructor.</a>
  <a id="Test.via-ctor"></a><a id="7086" href="Meta.Copattern.html#7086" class="Function">via-ctor</a> <a id="7095" class="Symbol">:</a> <a id="7097" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="7104" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="7108" href="Meta.Copattern.html#7086" class="Function">via-ctor</a> <a id="7117" class="Symbol">=</a> <a id="7119" href="Meta.Copattern.html#6964" class="InductiveConstructor">mk</a> <a id="7122" class="Symbol">⦃</a> <a id="7124" class="Argument">c</a> <a id="7126" class="Symbol">=</a> <a id="7128" class="Number">0</a> <a id="7130" class="Symbol">⦄</a> <a id="7132" class="Symbol">{</a><a id="7133" class="Argument">f</a> <a id="7135" class="Symbol">=</a> <a id="7137" class="Symbol">λ</a> <a id="7139" href="Meta.Copattern.html#7139" class="Bound">_</a> <a id="7141" class="Symbol">→</a> <a id="7143" class="Number">0</a><a id="7144" class="Symbol">}</a> <a id="7146" href="Foundations.Correspondences.Binary.Reflexive.html#337" class="Field">refl</a>

  <a id="7154" class="Comment">-- Both macros work.</a>
  <a id="7177" class="Keyword">unquoteDecl</a> <a id="Test.copat-decl-via-ctor"></a><a id="7189" href="Meta.Copattern.html#7189" class="Function">copat-decl-via-ctor</a> <a id="7209" class="Symbol">=</a> <a id="7211" href="Meta.Copattern.html#5164" class="Function">declare-copattern</a> <a id="7229" href="Meta.Copattern.html#7189" class="Function">copat-decl-via-ctor</a> <a id="7249" href="Meta.Copattern.html#7086" class="Function">via-ctor</a>

  <a id="Test.copat-def-via-ctor"></a><a id="7261" href="Meta.Copattern.html#7261" class="Function">copat-def-via-ctor</a> <a id="7280" class="Symbol">:</a> <a id="7282" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="7289" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
  <a id="7293" class="Keyword">unquoteDef</a> <a id="7304" href="Meta.Copattern.html#7261" class="Function">copat-def-via-ctor</a> <a id="7323" class="Symbol">=</a> <a id="7325" href="Meta.Copattern.html#5323" class="Function">define-copattern</a> <a id="7342" href="Meta.Copattern.html#7261" class="Function">copat-def-via-ctor</a> <a id="7361" href="Meta.Copattern.html#7086" class="Function">via-ctor</a>

  <a id="7373" class="Comment">-- Record created by a function.</a>
  <a id="7408" class="Keyword">module</a> <a id="7415" href="Meta.Copattern.html#7415" class="Module">_</a> <a id="7417" class="Symbol">(</a><a id="7418" href="Meta.Copattern.html#7418" class="Bound">r</a> <a id="7420" class="Symbol">:</a> <a id="7422" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="7429" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="7430" class="Symbol">)</a> <a id="7432" class="Keyword">where</a>
    <a id="7442" class="Keyword">open</a> <a id="7447" href="Meta.Copattern.html#6889" class="Module">Record</a> <a id="7454" href="Meta.Copattern.html#7418" class="Bound">r</a>
    <a id="7460" href="Meta.Copattern.html#7460" class="Function">via-function</a> <a id="7473" class="Symbol">:</a> <a id="7475" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="7482" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
    <a id="7488" href="Meta.Copattern.html#7460" class="Function">via-function</a> <a id="7501" class="Symbol">.</a><a id="7502" href="Meta.Copattern.html#6985" class="Field">c</a> <a id="7504" class="Symbol">=</a> <a id="7506" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="7510" href="Meta.Copattern.html#6985" class="Field">c</a>
    <a id="7516" href="Meta.Copattern.html#7460" class="Function">via-function</a> <a id="7529" class="Symbol">.</a><a id="7530" href="Meta.Copattern.html#7001" class="Field">f</a> <a id="7532" class="Symbol">=</a> <a id="7534" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="7538" href="Foundations.Pi.Base.html#2101" class="Function Operator">∘</a> <a id="7540" href="Meta.Copattern.html#7001" class="Field">f</a>
    <a id="7546" href="Meta.Copattern.html#7460" class="Function">via-function</a> <a id="7559" class="Symbol">.</a><a id="7560" href="Meta.Copattern.html#7019" class="Field">const′</a> <a id="7567" class="Symbol">=</a> <a id="7569" href="Foundations.Prim.Kan.html#1724" class="Function">ap</a> <a id="7572" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="7576" href="Meta.Copattern.html#7019" class="Field">const′</a>

  <a id="7586" class="Comment">-- Also works when applied to the result of a function.</a>
  <a id="7644" class="Keyword">unquoteDecl</a> <a id="Test.copat-decl-via-function"></a><a id="7656" href="Meta.Copattern.html#7656" class="Function">copat-decl-via-function</a> <a id="7680" class="Symbol">=</a> <a id="7682" href="Meta.Copattern.html#5164" class="Function">declare-copattern</a> <a id="7700" href="Meta.Copattern.html#7656" class="Function">copat-decl-via-function</a> <a id="7724" class="Symbol">(</a><a id="7725" href="Meta.Copattern.html#7460" class="Function">via-function</a> <a id="7738" href="Meta.Copattern.html#7086" class="Function">via-ctor</a><a id="7746" class="Symbol">)</a>

  <a id="7751" class="Comment">-- Test to see how we handle unused parameters.</a>
  <a id="7801" class="Keyword">record</a> <a id="Test.Unused"></a><a id="7808" href="Meta.Copattern.html#7808" class="Record">Unused</a> <a id="7815" class="Symbol">(</a><a id="7816" href="Meta.Copattern.html#7816" class="Bound">n</a> <a id="7818" class="Symbol">:</a> <a id="7820" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="7821" class="Symbol">)</a> <a id="7823" class="Symbol">:</a> <a id="7825" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="7830" class="Keyword">where</a>
    <a id="7840" class="Keyword">field</a> <a id="Test.Unused.actual"></a><a id="7846" href="Meta.Copattern.html#7846" class="Field">actual</a> <a id="7853" class="Symbol">:</a> <a id="7855" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

  <a id="Test.zero-unused-param"></a><a id="7860" href="Meta.Copattern.html#7860" class="Function">zero-unused-param</a> <a id="7878" class="Symbol">:</a> <a id="7880" href="Meta.Copattern.html#7808" class="Record">Unused</a> <a id="7887" class="Number">0</a>
  <a id="7891" href="Meta.Copattern.html#7860" class="Function">zero-unused-param</a> <a id="7909" class="Symbol">=</a> <a id="7911" class="Keyword">record</a> <a id="7918" class="Symbol">{</a> <a id="7920" href="Meta.Copattern.html#7846" class="Field">actual</a> <a id="7927" class="Symbol">=</a> <a id="7929" class="Number">0</a> <a id="7931" class="Symbol">}</a>

  <a id="Test.one-unused-param"></a><a id="7936" href="Meta.Copattern.html#7936" class="Function">one-unused-param</a> <a id="7953" class="Symbol">:</a> <a id="7955" class="Symbol">∀</a> <a id="7957" class="Symbol">{</a><a id="7958" href="Meta.Copattern.html#7958" class="Bound">n</a><a id="7959" class="Symbol">}</a> <a id="7961" class="Symbol">→</a> <a id="7963" href="Meta.Copattern.html#7808" class="Record">Unused</a> <a id="7970" href="Meta.Copattern.html#7958" class="Bound">n</a>
  <a id="7974" class="Keyword">unquoteDef</a> <a id="7985" href="Meta.Copattern.html#7936" class="Function">one-unused-param</a> <a id="8002" class="Symbol">=</a> <a id="8004" href="Meta.Copattern.html#5164" class="Function">declare-copattern</a> <a id="8022" href="Meta.Copattern.html#7936" class="Function">one-unused-param</a> <a id="8039" href="Meta.Copattern.html#7860" class="Function">zero-unused-param</a>
  <a id="8059" class="Comment">-- This is a type error:</a>
  <a id="8086" class="Comment">-- unquoteDef one-unused-param = define-copattern one-unused-param zero-unused-param</a>
  <a id="8173" class="Comment">-- because the &#39;define&#39; macro propagates the type of the thing being</a>
  <a id="8244" class="Comment">-- defined inwards.</a>

  <a id="8267" class="Comment">-- Functions into records that are universe polymorphic</a>
  <a id="Test.neat"></a><a id="8325" href="Meta.Copattern.html#8325" class="Function">neat</a> <a id="8330" class="Symbol">:</a> <a id="8332" class="Symbol">∀</a> <a id="8334" class="Symbol">{</a><a id="8335" href="Meta.Copattern.html#8335" class="Bound">ℓ</a><a id="8336" class="Symbol">}</a> <a id="8338" class="Symbol">{</a><a id="8339" href="Meta.Copattern.html#8339" class="Bound">A</a> <a id="8341" class="Symbol">:</a> <a id="8343" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="8348" href="Meta.Copattern.html#8335" class="Bound">ℓ</a><a id="8349" class="Symbol">}</a> <a id="8351" class="Symbol">→</a> <a id="8353" href="Meta.Copattern.html#8339" class="Bound">A</a> <a id="8355" class="Symbol">→</a> <a id="8357" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="8364" href="Meta.Copattern.html#8339" class="Bound">A</a>
  <a id="8368" href="Meta.Copattern.html#8325" class="Function">neat</a> <a id="8373" href="Meta.Copattern.html#8373" class="Bound">a</a> <a id="8375" class="Symbol">.</a><a id="8376" href="Meta.Copattern.html#6985" class="Field">Record.c</a> <a id="8385" class="Symbol">=</a> <a id="8387" href="Meta.Copattern.html#8373" class="Bound">a</a>
  <a id="8391" href="Meta.Copattern.html#8325" class="Function">neat</a> <a id="8396" href="Meta.Copattern.html#8396" class="Bound">a</a> <a id="8398" class="Symbol">.</a><a id="8399" href="Meta.Copattern.html#7001" class="Field">Record.f</a> <a id="8408" class="Symbol">_</a> <a id="8410" class="Symbol">=</a> <a id="8412" href="Meta.Copattern.html#8396" class="Bound">a</a>
  <a id="8416" href="Meta.Copattern.html#8325" class="Function">neat</a> <a id="8421" href="Meta.Copattern.html#8421" class="Bound">a</a> <a id="8423" class="Symbol">.</a><a id="8424" href="Meta.Copattern.html#7019" class="Field">Record.const′</a> <a id="8438" class="Symbol">=</a> <a id="8440" href="Foundations.Correspondences.Binary.Reflexive.html#337" class="Field">refl</a>

  <a id="8448" class="Comment">-- Implicit insertion is correct for the define- macro, since the type</a>
  <a id="8521" class="Comment">-- of the function is given.</a>
  <a id="Test.cool"></a><a id="8552" href="Meta.Copattern.html#8552" class="Function">cool</a> <a id="8557" class="Symbol">:</a> <a id="8559" class="Symbol">∀</a> <a id="8561" class="Symbol">{</a><a id="8562" href="Meta.Copattern.html#8562" class="Bound">ℓ</a><a id="8563" class="Symbol">}</a> <a id="8565" class="Symbol">{</a><a id="8566" href="Meta.Copattern.html#8566" class="Bound">A</a> <a id="8568" class="Symbol">:</a> <a id="8570" href="Foundations.Prim.Type.html#322" class="Primitive">Type</a> <a id="8575" href="Meta.Copattern.html#8562" class="Bound">ℓ</a><a id="8576" class="Symbol">}</a> <a id="8578" class="Symbol">→</a> <a id="8580" href="Meta.Copattern.html#8566" class="Bound">A</a> <a id="8582" class="Symbol">→</a> <a id="8584" href="Meta.Copattern.html#6889" class="Record">Record</a> <a id="8591" href="Meta.Copattern.html#8566" class="Bound">A</a>
  <a id="8595" class="Keyword">unquoteDef</a> <a id="8606" href="Meta.Copattern.html#8552" class="Function">cool</a> <a id="8611" class="Symbol">=</a> <a id="8613" href="Meta.Copattern.html#5980" class="Function">define-copatternω</a> <a id="8631" href="Meta.Copattern.html#8552" class="Function">cool</a> <a id="8636" href="Meta.Copattern.html#8325" class="Function">neat</a>

  <a id="8644" class="Comment">-- Eta-expanders</a>
  <a id="Test.expander"></a><a id="8663" href="Meta.Copattern.html#8663" class="Function">expander</a> <a id="8672" class="Symbol">:</a> <a id="8674" class="Symbol">∀</a> <a id="8676" class="Symbol">{</a><a id="8677" href="Meta.Copattern.html#8677" class="Bound">m</a> <a id="8679" href="Meta.Copattern.html#8679" class="Bound">n</a> <a id="8681" class="Symbol">:</a> <a id="8683" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="8684" class="Symbol">}</a> <a id="8686" class="Symbol">→</a> <a id="8688" href="Meta.Copattern.html#7808" class="Record">Unused</a> <a id="8695" href="Meta.Copattern.html#8677" class="Bound">m</a> <a id="8697" class="Symbol">→</a> <a id="8699" href="Meta.Copattern.html#7808" class="Record">Unused</a> <a id="8706" href="Meta.Copattern.html#8679" class="Bound">n</a>
  <a id="8710" class="Keyword">unquoteDef</a> <a id="8721" href="Meta.Copattern.html#8663" class="Function">expander</a> <a id="8730" class="Symbol">=</a> <a id="8732" href="Meta.Copattern.html#6513" class="Function">define-eta-expansion</a> <a id="8753" href="Meta.Copattern.html#8663" class="Function">expander</a>

  <a id="8765" class="Comment">-- Raises a type error: the function should have a declaration.</a>
  <a id="8831" class="Comment">-- unquoteDecl uncool = define-copatternω uncool neat</a>
</pre></body></html>